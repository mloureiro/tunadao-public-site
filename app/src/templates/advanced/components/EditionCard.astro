---
/**
 * Advanced Template EditionCard
 *
 * Clean, gallery-like cards with editorial layout.
 * Generous whitespace, subtle borders, content hierarchy through typography weight.
 * Poster as a refined element, not dominating.
 * Awards in a clean list format. Tunas as a text list.
 */

import Award from './Award.astro';
import ResponsiveImage from '@components/ResponsiveImage.astro';
import type { FrontendCitadaoEdition } from '@lib/cms/types';
import { groupAwardsByTuna, extractPublicId } from '@lib/cms';

interface Props {
  edition: FrontendCitadaoEdition;
  labels: {
    edition: string;
    participatingTunas: string;
    guests: string;
    awards: string;
    awardLabel: (_key: string) => string;
  };
}

const { edition, labels } = Astro.props;
const posterPublicId = edition.posterUrl ? extractPublicId(edition.posterUrl) : null;

const awardWinningTunas = groupAwardsByTuna(edition);
const awardWinnerShortNames = new Set(awardWinningTunas.map(({ tuna }) => tuna.shortName));
const tunasWithoutAwards = edition.tunas.filter((tuna) => !awardWinnerShortNames.has(tuna.shortName));
---

<article class="adv-edition" id={`citadao-${edition.year}`}>
  <header class="adv-edition__header">
    <div class="adv-edition__title-group">
      <span class="adv-edition__ordinal">{edition.edition}{labels.edition}</span>
      <h3 class="adv-edition__title">CITADAO {edition.year}</h3>
    </div>
    <div class="adv-edition__meta">
      {edition.date && <span class="adv-edition__date">{edition.date}</span>}
      {edition.venue && <span class="adv-edition__venue">{edition.venue}</span>}
    </div>
    {edition.notes && <span class="adv-edition__note">{edition.notes}</span>}
  </header>

  <div class={`adv-edition__body ${edition.posterUrl ? 'has-poster' : ''}`}>
    {edition.posterUrl && (
      <div class="adv-edition__poster">
        <button
          type="button"
          class="adv-edition__poster-btn"
          data-poster-url={edition.posterUrl}
          data-poster-alt={`Cartaz do ${edition.edition}\u00BA Citad\u00E3o (${edition.year})`}
        >
          {posterPublicId ? (
            <ResponsiveImage
              publicId={posterPublicId}
              alt={`Cartaz do ${edition.edition}\u00BA Citad\u00E3o (${edition.year})`}
              class="adv-edition__poster-img"
              sizes="(max-width: 768px) 100vw, 240px"
              aspectRatio="2/3"
            />
          ) : (
            <img
              src={edition.posterUrl}
              alt={`Cartaz do ${edition.edition}\u00BA Citad\u00E3o (${edition.year})`}
              class="adv-edition__poster-img"
              loading="lazy"
            />
          )}
        </button>
      </div>
    )}

    <div class="adv-edition__details">
      {/* Participating Tunas (without awards) */}
      {tunasWithoutAwards.length > 0 && (
        <div class="adv-edition__section">
          <h4 class="adv-edition__section-title">{labels.participatingTunas}</h4>
          <ul class="adv-edition__tuna-list">
            {tunasWithoutAwards.map((tuna) => (
              <li class="adv-edition__tuna-item">
                {tuna.logoUrl ? (
                  <img
                    src={tuna.logoUrl}
                    alt=""
                    class="adv-edition__tuna-logo"
                    loading="lazy"
                  />
                ) : (
                  <span class="adv-edition__tuna-initial">{tuna.shortName.charAt(0)}</span>
                )}
                <span class="adv-edition__tuna-name" title={tuna.fullName}>{tuna.shortName}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* Guests */}
      {edition.guests && edition.guests.length > 0 && (
        <div class="adv-edition__section">
          <h4 class="adv-edition__section-title">{labels.guests}</h4>
          <ul class="adv-edition__tuna-list">
            {edition.guests.map((guest) => (
              <li class="adv-edition__tuna-item adv-edition__tuna-item--guest">
                {guest.logoUrl ? (
                  <img
                    src={guest.logoUrl}
                    alt=""
                    class="adv-edition__tuna-logo"
                    loading="lazy"
                  />
                ) : (
                  <span class="adv-edition__tuna-initial">{guest.shortName.charAt(0)}</span>
                )}
                <span class="adv-edition__tuna-name" title={guest.fullName}>{guest.shortName}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* Awards by Tuna */}
      {edition.awards && Object.keys(edition.awards).length > 0 && (
        <div class="adv-edition__section adv-edition__section--awards">
          <h4 class="adv-edition__section-title">{labels.awards}</h4>
          <div class="adv-edition__awards-table">
            {groupAwardsByTuna(edition).map(({ tuna, awards }) => (
              <div class="adv-edition__award-row">
                <div class="adv-edition__award-tuna">
                  {tuna.logoUrl ? (
                    <img
                      src={tuna.logoUrl}
                      alt=""
                      class="adv-edition__award-tuna-logo"
                      loading="lazy"
                    />
                  ) : (
                    <span class="adv-edition__award-tuna-initial">{tuna.shortName.charAt(0)}</span>
                  )}
                  <span class="adv-edition__award-tuna-name">{tuna.shortName}</span>
                </div>
                <div class="adv-edition__award-badges">
                  {awards.map((key) => (
                    <Award awardKey={key} size="sm">{labels.awardLabel(key)}</Award>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>
</article>

<style>
  .adv-edition {
    border: 1px solid var(--advanced-border);
    border-radius: 4px;
    overflow: hidden;
    background-color: var(--advanced-bg);
  }

  /* Header */
  .adv-edition__header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--advanced-border-subtle);
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 1rem 2rem;
  }

  .adv-edition__title-group {
    flex: 1;
    min-width: 180px;
  }

  .adv-edition__ordinal {
    display: block;
    font-size: 0.6875rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--advanced-accent-muted);
    margin-bottom: 0.25rem;
  }

  .adv-edition__title {
    font-size: clamp(1.375rem, 3vw, 1.75rem);
    font-weight: 300;
    letter-spacing: -0.02em;
    color: var(--advanced-text);
    margin: 0;
    line-height: 1.1;
  }

  .adv-edition__meta {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    text-align: right;
    font-size: 0.8125rem;
    color: var(--advanced-text-muted);
    font-weight: 400;
  }

  .adv-edition__date {
    color: var(--advanced-text-secondary);
  }

  .adv-edition__note {
    font-size: 0.6875rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--advanced-accent);
    padding: 0.25rem 0.75rem;
    border: 1px solid var(--advanced-accent-muted);
    border-radius: 2px;
    align-self: center;
  }

  /* Body */
  .adv-edition__body {
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  @media (min-width: 768px) {
    .adv-edition__body.has-poster {
      flex-direction: row;
    }

    .adv-edition__body.has-poster .adv-edition__poster {
      flex-shrink: 0;
      width: 240px;
    }

    .adv-edition__body.has-poster .adv-edition__details {
      flex: 1;
      min-width: 0;
    }
  }

  /* Poster */
  .adv-edition__poster {
    display: flex;
    justify-content: center;
  }

  .adv-edition__poster-btn {
    display: block;
    max-width: 240px;
    overflow: hidden;
    border: 1px solid var(--advanced-border);
    border-radius: 2px;
    cursor: zoom-in;
    padding: 0;
    background: none;
    transition: border-color 300ms ease;
  }

  .adv-edition__poster-btn:hover {
    border-color: var(--advanced-text-muted);
  }

  .adv-edition__poster-img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Details */
  .adv-edition__details {
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }

  /* Section */
  .adv-edition__section-title {
    font-size: 0.6875rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--advanced-text-muted);
    margin: 0 0 0.75rem 0;
  }

  /* Tuna list */
  .adv-edition__tuna-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .adv-edition__tuna-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .adv-edition__tuna-logo {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid var(--advanced-border);
  }

  .adv-edition__tuna-initial {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.6875rem;
    font-weight: 500;
    color: var(--advanced-text-muted);
    border: 1px solid var(--advanced-border);
    background: var(--advanced-surface);
  }

  .adv-edition__tuna-name {
    font-size: 0.8125rem;
    color: var(--advanced-text-secondary);
    font-weight: 400;
  }

  .adv-edition__tuna-item--guest .adv-edition__tuna-name {
    color: var(--advanced-text-muted);
    font-style: italic;
  }

  /* Awards table */
  .adv-edition__section--awards {
    grid-column: 1 / -1;
  }

  .adv-edition__awards-table {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .adv-edition__award-row {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border: 1px solid var(--advanced-border-subtle);
    border-radius: 2px;
    background: var(--advanced-bg-elevated);
  }

  @media (min-width: 480px) {
    .adv-edition__award-row {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
  }

  .adv-edition__award-tuna {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .adv-edition__award-tuna-logo {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid var(--advanced-border);
  }

  .adv-edition__award-tuna-initial {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.625rem;
    font-weight: 500;
    color: var(--advanced-text-muted);
    border: 1px solid var(--advanced-border);
    background: var(--advanced-surface);
  }

  .adv-edition__award-tuna-name {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--advanced-text);
  }

  .adv-edition__award-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  /* Responsive */
  @media (max-width: 767px) {
    .adv-edition__header {
      padding: 1.25rem;
    }

    .adv-edition__body {
      padding: 1.25rem;
    }

    .adv-edition__meta {
      text-align: left;
    }
  }
</style>
