---
/**
 * Advanced Template FestivalCard
 *
 * Understated elegance. Card as a content block rather than flashy card.
 * Festival name prominent with refined typography.
 * Location subtle. Awards as a clean horizontal list.
 */

import Award from './Award.astro';
import ResponsiveImage from '@components/ResponsiveImage.astro';
import type { FrontendPalmaresFestival } from '@lib/cms/types';
import { sortAwards, isTopPrize, extractPublicId } from '@lib/cms';

interface Props {
  festival: FrontendPalmaresFestival;
  organizerLabel?: string;
  participationLabel?: string;
}

const { festival, organizerLabel = 'Organização', participationLabel = 'Participação' } = Astro.props;

const sortedAwards = sortAwards(festival.awards);
const hasTopPrize = sortedAwards.length > 0 && isTopPrize(sortedAwards[0].slug);
const hasNoAwards = sortedAwards.length === 0;
const festivalInitial = festival.name.charAt(0).toUpperCase();
const posterPublicId = festival.posterUrl ? extractPublicId(festival.posterUrl) : null;
---

<article class:list={['adv-festival', { 'adv-festival--featured': hasTopPrize }]}>
  {/* Poster */}
  <div class="adv-festival__poster">
    {festival.posterUrl ? (
      <button
        type="button"
        class="adv-festival__poster-btn"
        data-poster-url={festival.posterUrl}
        data-poster-alt={`Cartaz ${festival.name}`}
      >
        {posterPublicId ? (
          <ResponsiveImage
            publicId={posterPublicId}
            alt={`Cartaz ${festival.name}`}
            class="adv-festival__poster-img"
            sizes="(max-width: 768px) 50vw, 280px"
            aspectRatio="3/4"
          />
        ) : (
          <img
            src={festival.posterUrl}
            alt={`Cartaz ${festival.name}`}
            class="adv-festival__poster-img"
            loading="lazy"
          />
        )}
      </button>
    ) : (
      <div class="adv-festival__poster-empty">
        <span class="adv-festival__poster-initial">{festivalInitial}</span>
      </div>
    )}
  </div>

  {/* Content */}
  <div class="adv-festival__content">
    <header class="adv-festival__header">
      <h3 class="adv-festival__name">{festival.name}</h3>
      {festival.location && (
        <p class="adv-festival__location">{festival.location}</p>
      )}
    </header>

    {/* Organizer */}
    {festival.organizingTuna && (
      <div class="adv-festival__organizer">
        <span class="adv-festival__organizer-label">{organizerLabel}</span>
        <div class="adv-festival__organizer-info">
          {festival.organizingTuna.logoUrl ? (
            <img
              src={festival.organizingTuna.logoUrl}
              alt=""
              class="adv-festival__organizer-logo"
              loading="lazy"
            />
          ) : (
            <span class="adv-festival__organizer-initial">
              {festival.organizingTuna.shortName.charAt(0)}
            </span>
          )}
          {festival.organizingTuna.website ? (
            <a
              href={festival.organizingTuna.website}
              target="_blank"
              rel="noopener noreferrer"
              class="adv-festival__organizer-name"
              title={festival.organizingTuna.fullName}
            >
              {festival.organizingTuna.shortName}
            </a>
          ) : (
            <span class="adv-festival__organizer-name" title={festival.organizingTuna.fullName}>
              {festival.organizingTuna.shortName}
            </span>
          )}
        </div>
      </div>
    )}

    {/* Awards */}
    <footer class="adv-festival__awards">
      {hasNoAwards ? (
        <Award awardKey="premio-participacao" size="sm">{participationLabel}</Award>
      ) : (
        sortedAwards.map((award) => (
          <Award awardKey={award.slug} size="sm">{award.name}</Award>
        ))
      )}
    </footer>
  </div>
</article>

<style>
  .adv-festival {
    display: flex;
    flex-direction: column;
    border: 1px solid var(--advanced-border);
    border-radius: 4px;
    overflow: hidden;
    background-color: var(--advanced-bg);
    transition: border-color 300ms ease;
  }

  .adv-festival:hover {
    border-color: var(--advanced-text-muted);
  }

  .adv-festival--featured {
    border-color: var(--advanced-accent-muted);
  }

  .adv-festival--featured:hover {
    border-color: var(--advanced-accent);
  }

  /* Poster */
  .adv-festival__poster {
    position: relative;
    aspect-ratio: 3 / 4;
    background-color: var(--advanced-surface);
    overflow: hidden;
  }

  .adv-festival__poster-btn {
    display: block;
    width: 100%;
    height: 100%;
    border: none;
    padding: 0;
    background: none;
    cursor: zoom-in;
  }

  .adv-festival__poster-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 400ms ease;
  }

  .adv-festival:hover .adv-festival__poster-img {
    opacity: 0.9;
  }

  .adv-festival__poster-empty {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--advanced-surface);
  }

  .adv-festival__poster-initial {
    font-size: 2.5rem;
    font-weight: 300;
    color: var(--advanced-text-muted);
    opacity: 0.5;
  }

  /* Content */
  .adv-festival__content {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.875rem;
    flex: 1;
  }

  .adv-festival__header {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .adv-festival__name {
    font-size: 0.9375rem;
    font-weight: 300;
    color: var(--advanced-text);
    line-height: 1.3;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .adv-festival__location {
    font-size: 0.75rem;
    color: var(--advanced-text-muted);
    margin: 0;
    letter-spacing: 0.02em;
  }

  /* Organizer */
  .adv-festival__organizer {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--advanced-border-subtle);
    margin-top: auto;
  }

  .adv-festival__organizer-label {
    font-size: 0.625rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--advanced-text-muted);
    font-weight: 400;
  }

  .adv-festival__organizer-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .adv-festival__organizer-logo {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: contain;
    border: 1px solid var(--advanced-border);
    background: var(--advanced-surface);
    padding: 2px;
  }

  .adv-festival__organizer-initial {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.5625rem;
    font-weight: 500;
    color: var(--advanced-accent);
    border: 1px solid var(--advanced-border);
    background: var(--advanced-surface);
  }

  .adv-festival__organizer-name {
    font-size: 0.8125rem;
    font-weight: 400;
    color: var(--advanced-text-secondary);
    text-decoration: none;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    transition: color 200ms ease;
  }

  a.adv-festival__organizer-name:hover {
    color: var(--advanced-accent);
  }

  /* Awards */
  .adv-festival__awards {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--advanced-border-subtle);
  }

  .adv-festival__awards:empty {
    display: none;
  }
</style>
