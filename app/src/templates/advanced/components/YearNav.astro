---
/**
 * Advanced Template YearNav
 *
 * Refined year navigation with thin lines and gold active state.
 * Desktop: Minimal vertical sidebar with subtle dots and clean year labels.
 * Mobile: Floating pill with dropdown.
 * Scroll-based active year tracking via IntersectionObserver.
 */
interface Props {
  years: number[];
  idPrefix?: string;
  ariaLabel?: string;
}

const { years, idPrefix = 'year', ariaLabel = 'Jump to year' } = Astro.props;

const sortedYears = [...years].sort((a, b) => b - a);
---

<!-- Desktop: Vertical sidebar -->
<nav class="adv-timeline" aria-label={ariaLabel} data-id-prefix={idPrefix}>
  <div class="adv-timeline__track">
    <div class="adv-timeline__line" aria-hidden="true"></div>
    <ul class="adv-timeline__list" role="list">
      {sortedYears.map((year) => (
        <li class="adv-timeline__item">
          <a
            href={`#${idPrefix}-${year}`}
            class="adv-timeline__link"
            data-year={year}
            aria-label={`Jump to ${year}`}
          >
            <span class="adv-timeline__dot" aria-hidden="true"></span>
            <span class="adv-timeline__label">{year}</span>
          </a>
        </li>
      ))}
    </ul>
  </div>
</nav>

<!-- Mobile: Floating pill -->
<div class="adv-year-pill" aria-hidden="true">
  <button class="adv-year-pill__btn" type="button" aria-label="Current year navigation">
    <span class="adv-year-pill__text"></span>
    <svg class="adv-year-pill__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M6 9l6 6 6-6"/>
    </svg>
  </button>
  <div class="adv-year-pill__dropdown">
    <ul class="adv-year-pill__list" role="list">
      {sortedYears.map((year) => (
        <li>
          <a href={`#${idPrefix}-${year}`} class="adv-year-pill__link" data-year={year}>
            {year}
          </a>
        </li>
      ))}
    </ul>
  </div>
</div>

<script>
  (function() {
    function initAdvTimeline() {
      const nav = document.querySelector('.adv-timeline');
      const pill = document.querySelector('.adv-year-pill');
      const pillText = pill?.querySelector('.adv-year-pill__text');
      const pillBtn = pill?.querySelector('.adv-year-pill__btn');
      const dropdown = pill?.querySelector('.adv-year-pill__dropdown');

      if (!nav) return;

      const idPrefix = nav.getAttribute('data-id-prefix') || 'year';
      const yearLinks = nav.querySelectorAll('.adv-timeline__link');
      const pillLinks = pill?.querySelectorAll('.adv-year-pill__link');
      const yearSections: Element[] = [];

      yearLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href) {
          const section = document.querySelector(href);
          if (section) yearSections.push(section);
        }
      });

      if (yearSections.length === 0) return;

      let currentYear: string | null = null;

      function updateActiveYear(year: string) {
        if (year === currentYear) return;
        currentYear = year;

        yearLinks.forEach(link => {
          const linkYear = link.getAttribute('data-year');
          const isActive = linkYear === year;
          link.classList.toggle('adv-timeline__link--active', isActive);
          link.setAttribute('aria-current', isActive ? 'true' : 'false');
        });

        if (pillText) pillText.textContent = year;

        pillLinks?.forEach(link => {
          const linkYear = link.getAttribute('data-year');
          link.classList.toggle('adv-year-pill__link--active', linkYear === year);
        });
      }

      // IntersectionObserver for scroll-based tracking
      const observer = new IntersectionObserver((entries) => {
        const visible = entries.filter(e => e.isIntersecting);
        if (visible.length > 0) {
          visible.sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);
          const year = visible[0].target.id.replace(new RegExp(`^${idPrefix}-`), '');
          updateActiveYear(year);
        }
      }, {
        rootMargin: '-20% 0px -60% 0px',
        threshold: 0
      });

      yearSections.forEach(section => observer.observe(section));

      // Show/hide based on scroll position
      const showObserver = new IntersectionObserver((entries) => {
        const isVisible = entries[0].isIntersecting;
        pill?.classList.toggle('adv-year-pill--visible', !isVisible);
        nav.classList.toggle('adv-timeline--active', !isVisible);
      }, { threshold: 0.5 });

      if (yearSections[0]) showObserver.observe(yearSections[0]);

      // Smooth scroll handler
      function handleClick(e: Event) {
        e.preventDefault();
        const link = e.currentTarget as HTMLElement;
        const href = link.getAttribute('href');
        if (!href) return;
        const target = document.querySelector(href);
        if (!target) return;

        dropdown?.classList.remove('adv-year-pill__dropdown--open');

        const offset = 100;
        const pos = target.getBoundingClientRect().top + window.pageYOffset - offset;
        window.scrollTo({ top: pos, behavior: 'smooth' });
      }

      yearLinks.forEach(link => link.addEventListener('click', handleClick));
      pillLinks?.forEach(link => link.addEventListener('click', handleClick));

      // Toggle dropdown
      pillBtn?.addEventListener('click', () => {
        dropdown?.classList.toggle('adv-year-pill__dropdown--open');
      });

      document.addEventListener('click', (e) => {
        if (!pill?.contains(e.target as Node)) {
          dropdown?.classList.remove('adv-year-pill__dropdown--open');
        }
      });

      // Keyboard navigation
      nav.addEventListener('keydown', (event) => {
        const e = event as KeyboardEvent;
        const links = Array.from(yearLinks);
        const idx = links.findIndex(l => l === document.activeElement);
        if (idx === -1) return;

        let next = idx;
        switch (e.key) {
          case 'ArrowDown': case 'ArrowRight':
            e.preventDefault(); next = Math.min(idx + 1, links.length - 1); break;
          case 'ArrowUp': case 'ArrowLeft':
            e.preventDefault(); next = Math.max(idx - 1, 0); break;
          case 'Home':
            e.preventDefault(); next = 0; break;
          case 'End':
            e.preventDefault(); next = links.length - 1; break;
        }
        if (next !== idx) (links[next] as HTMLElement).focus();
      });

      // Initial state
      if (yearSections[0]) {
        const first = yearSections[0].id.replace(new RegExp(`^${idPrefix}-`), '');
        updateActiveYear(first);
        if (pillText) pillText.textContent = first;
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAdvTimeline);
    } else {
      initAdvTimeline();
    }
  })();
</script>

<style>
  /* Desktop Vertical Timeline */
  .adv-timeline {
    display: none;
    position: fixed;
    left: var(--space-4);
    top: 50%;
    transform: translateY(-50%);
    z-index: 40;
    opacity: 0;
    transition: opacity 300ms ease;
    pointer-events: none;
  }

  .adv-timeline--active {
    opacity: 1;
    pointer-events: auto;
  }

  @media (min-width: 1200px) {
    .adv-timeline {
      display: block;
    }
  }

  .adv-timeline__track {
    position: relative;
    padding: var(--space-4) 0;
  }

  .adv-timeline__line {
    position: absolute;
    left: 4px;
    top: 0;
    bottom: 0;
    width: 1px;
    background: linear-gradient(
      to bottom,
      transparent,
      var(--advanced-border) 10%,
      var(--advanced-border) 90%,
      transparent
    );
  }

  .adv-timeline__list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .adv-timeline__item {
    margin: 0;
  }

  .adv-timeline__link {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: 3px var(--space-2) 3px 0;
    text-decoration: none;
    transition: all 200ms ease;
    border-radius: 2px;
  }

  .adv-timeline__link:focus-visible {
    outline: 1px solid var(--advanced-accent);
    outline-offset: 2px;
  }

  .adv-timeline__dot {
    width: 9px;
    height: 9px;
    border-radius: 50%;
    background-color: transparent;
    border: 1px solid var(--advanced-border);
    transition: all 200ms ease;
    flex-shrink: 0;
  }

  .adv-timeline__label {
    font-size: 0.6875rem;
    font-weight: 400;
    color: var(--advanced-text-muted);
    opacity: 0;
    transform: translateX(-4px);
    transition: all 200ms ease;
    white-space: nowrap;
    letter-spacing: 0.02em;
  }

  .adv-timeline__link:hover .adv-timeline__dot {
    border-color: var(--advanced-text-secondary);
  }

  .adv-timeline__link:hover .adv-timeline__label {
    opacity: 1;
    transform: translateX(0);
    color: var(--advanced-text-secondary);
  }

  .adv-timeline__link--active .adv-timeline__dot {
    background-color: var(--advanced-accent);
    border-color: var(--advanced-accent);
    box-shadow: 0 0 6px var(--advanced-accent-glow);
  }

  .adv-timeline__link--active .adv-timeline__label {
    opacity: 1;
    transform: translateX(0);
    color: var(--advanced-accent);
    font-weight: 500;
  }

  /* Mobile Pill */
  .adv-year-pill {
    position: fixed;
    bottom: var(--space-6);
    right: var(--space-6);
    z-index: 50;
    opacity: 0;
    transform: translateY(10px);
    transition: all 300ms ease;
    pointer-events: none;
  }

  .adv-year-pill--visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  @media (min-width: 1200px) {
    .adv-year-pill {
      display: none;
    }
  }

  .adv-year-pill__btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    background-color: var(--advanced-bg-elevated);
    color: var(--advanced-accent);
    border: 1px solid var(--advanced-border);
    padding: 0.5rem 1rem;
    border-radius: 100px;
    font-size: 0.9375rem;
    font-weight: 500;
    letter-spacing: 0.04em;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    transition: all 200ms ease;
  }

  .adv-year-pill__btn:hover {
    border-color: var(--advanced-accent-muted);
  }

  .adv-year-pill__btn:focus-visible {
    outline: 1px solid var(--advanced-accent);
    outline-offset: 4px;
  }

  .adv-year-pill__icon {
    width: 14px;
    height: 14px;
    transition: transform 200ms ease;
  }

  .adv-year-pill__dropdown {
    position: absolute;
    bottom: 100%;
    right: 0;
    margin-bottom: var(--space-2);
    background-color: var(--advanced-bg-elevated);
    border: 1px solid var(--advanced-border);
    border-radius: 8px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
    max-height: 280px;
    overflow-y: auto;
    opacity: 0;
    visibility: hidden;
    transform: translateY(8px);
    transition: all 200ms ease;
  }

  .adv-year-pill__dropdown--open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .adv-year-pill__list {
    list-style: none;
    margin: 0;
    padding: 0.375rem;
    display: flex;
    flex-direction: column;
    gap: 1px;
  }

  .adv-year-pill__link {
    display: block;
    padding: 0.5rem 1.25rem;
    font-size: 0.8125rem;
    font-weight: 400;
    color: var(--advanced-text-secondary);
    text-decoration: none;
    border-radius: 4px;
    transition: all 150ms ease;
    text-align: center;
    min-width: 72px;
    letter-spacing: 0.02em;
  }

  .adv-year-pill__link:hover {
    color: var(--advanced-text);
    background-color: var(--advanced-surface-hover);
  }

  .adv-year-pill__link--active {
    color: var(--advanced-accent);
    font-weight: 500;
  }

  @media (max-width: 640px) {
    .adv-year-pill {
      bottom: var(--space-4);
      right: var(--space-4);
    }
  }

  /* Scrollbar inside dropdown */
  .adv-year-pill__dropdown::-webkit-scrollbar {
    width: 4px;
  }

  .adv-year-pill__dropdown::-webkit-scrollbar-track {
    background: transparent;
  }

  .adv-year-pill__dropdown::-webkit-scrollbar-thumb {
    background: var(--advanced-border);
    border-radius: 2px;
  }
</style>
