---
/**
 * Experimental Template - EditionCard (v2)
 * Full-width band with 2 zones:
 *   Zone 1 — Edition header + Poster (30%) + Content (70%), alternating direction
 *   Zone 2 — Notes (optional)
 * No stats bar. Tunas as comma-separated text. Awards as "Award — Tuna" pairs.
 */

import ResponsiveImage from '@components/ResponsiveImage.astro';
import type { FrontendCitadaoEdition } from '@lib/cms/types';
import { extractPublicId, isTopPrize } from '@lib/cms';

interface Props {
  edition: FrontendCitadaoEdition;
  labels: {
    edition: string;
    participatingTunas: string;
    guests: string;
    awards: string;
    awardLabel: (_key: string) => string;
  };
}

const { edition, labels } = Astro.props;
const posterPublicId = edition.posterUrl ? extractPublicId(edition.posterUrl) : null;
const hasPoster = !!edition.posterUrl;
const isReversed = edition.edition % 2 === 0;
const hasAwards = edition.awards && Object.keys(edition.awards).length > 0;
const awardEntries = hasAwards ? Object.entries(edition.awards!) : [];
---

<article class:list={['exp-ed', { 'exp-ed--reversed': isReversed }]} id={`citadao-${edition.year}`}>
  {/* Edition header — always visible at top on mobile */}
  <div class="exp-ed__header exp-ed__header--mobile">
    <h3 class="exp-ed__title">
      <span class="exp-ed__edition">#{edition.edition}</span>
      <span class="exp-ed__sep" aria-hidden="true">&mdash;</span>
      <span class="exp-ed__year">{edition.year}</span>
    </h3>
    <p class="exp-ed__meta">{edition.date} &middot; {edition.venue}</p>
  </div>

  {/* Zone 1: Poster + Content (two-column on desktop) */}
  <div class:list={['exp-ed__body', { 'exp-ed__body--no-poster': !hasPoster }]}>
    {/* Poster column */}
    {hasPoster && (
      <div class="exp-ed__poster">
        <button
          type="button"
          class="exp-ed__poster-btn"
          data-poster-url={edition.posterUrl}
          data-poster-alt={`Cartaz do ${edition.edition}. Citadao (${edition.year})`}
        >
          {posterPublicId ? (
            <ResponsiveImage
              publicId={posterPublicId}
              alt={`Cartaz do ${edition.edition}. Citadao (${edition.year})`}
              class="exp-ed__poster-img"
              sizes="(max-width: 768px) 100vw, 30vw"
              aspectRatio="2/3"
            />
          ) : (
            <img
              src={edition.posterUrl}
              alt={`Cartaz do ${edition.edition}. Citadao (${edition.year})`}
              class="exp-ed__poster-img"
              loading="lazy"
            />
          )}
        </button>
      </div>
    )}

    {/* Content column */}
    <div class="exp-ed__content">
      {/* Edition header — desktop only (inside content column) */}
      <div class="exp-ed__header exp-ed__header--desktop">
        <h3 class="exp-ed__title">
          <span class="exp-ed__edition">#{edition.edition}</span>
          <span class="exp-ed__sep" aria-hidden="true">&mdash;</span>
          <span class="exp-ed__year">{edition.year}</span>
        </h3>
        <p class="exp-ed__meta">{edition.date} &middot; {edition.venue}</p>
      </div>

      {/* Tunas list — comma-separated text */}
      {edition.tunas.length > 0 && (
        <div class="exp-ed__tunas">
          <span class="exp-ed__label">{labels.participatingTunas}:</span>
          <span class="exp-ed__tuna-list">
            {edition.tunas.map((tuna, i) => (
              <>{i > 0 && ', '}<span title={tuna.fullName}>{tuna.shortName}</span></>
            ))}
          </span>
        </div>
      )}

      {/* Guests — visually distinct */}
      {edition.guests && edition.guests.length > 0 && (
        <div class="exp-ed__guests">
          <span class="exp-ed__guests-label">{labels.guests}:</span>
          <span class="exp-ed__guests-list">
            {edition.guests.map((guest, i) => (
              <>{i > 0 && ', '}<span title={guest.fullName}>{guest.shortName}</span></>
            ))}
          </span>
        </div>
      )}

      {/* Awards — "Award Name — Tuna Name" pairs */}
      {hasAwards && (
        <div class="exp-ed__awards">
          {awardEntries.map(([key, tunaShortName]) => (
            <p class:list={['exp-ed__award-line', { 'exp-ed__award-line--top': isTopPrize(key) }]}>
              {labels.awardLabel(key)} <span class="exp-ed__award-sep">&mdash;</span> {tunaShortName}
            </p>
          ))}
        </div>
      )}
    </div>
  </div>

  {/* Zone 2: Notes (optional) */}
  {edition.notes && (
    <div class="exp-ed__notes">
      {edition.notes}
    </div>
  )}
</article>

<style>
  .exp-ed {
    position: relative;
    margin-bottom: 80px;
  }

  .exp-ed:last-child {
    margin-bottom: 0;
  }

  /* Header: show desktop version by default, hide mobile */
  .exp-ed__header--mobile {
    display: none;
  }

  .exp-ed__header--desktop {
    display: block;
  }

  /* Zone 1: Poster + Content */
  .exp-ed__body {
    display: flex;
    gap: var(--exp-space-md);
    align-items: flex-start;
  }

  /* Poster column: 30%, capped height */
  .exp-ed__poster {
    width: 30%;
    flex-shrink: 0;
  }

  .exp-ed__poster-btn {
    display: block;
    width: 100%;
    border: none;
    padding: 0;
    background: none;
    cursor: zoom-in;
  }

  .exp-ed__poster-img,
  .exp-ed__poster :global(img) {
    width: 100%;
    max-height: 350px;
    object-fit: cover;
    display: block;
  }

  /* Content column */
  .exp-ed__content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: var(--exp-space-sm);
  }

  /* Edition header */
  .exp-ed__header {
    margin-bottom: var(--exp-space-xs);
  }

  .exp-ed__title {
    margin: 0;
    font-family: var(--exp-font-display);
    font-size: clamp(1.3rem, 3vw, 1.8rem);
    font-weight: 700;
    color: var(--exp-text);
    line-height: 1.2;
  }

  .exp-ed__edition {
    color: var(--exp-accent);
  }

  .exp-ed__sep {
    color: var(--exp-text-muted);
    opacity: 0.5;
  }

  .exp-ed__year {
    color: var(--exp-text);
  }

  .exp-ed__meta {
    margin: 0.25em 0 0;
    font-family: var(--exp-font-body);
    font-size: 0.85rem;
    color: var(--exp-text-muted);
  }

  /* Tunas list */
  .exp-ed__tunas {
    font-family: var(--exp-font-body);
    font-size: 0.9rem;
    color: var(--exp-text);
    line-height: 1.5;
  }

  .exp-ed__label {
    font-weight: 600;
    color: var(--exp-text-muted);
    margin-right: 0.3em;
  }

  .exp-ed__tuna-list {
    color: var(--exp-text);
  }

  /* Guests — visually distinct with accent label */
  .exp-ed__guests {
    font-family: var(--exp-font-body);
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .exp-ed__guests-label {
    font-weight: 600;
    color: var(--exp-accent);
    margin-right: 0.3em;
  }

  .exp-ed__guests-list {
    color: var(--exp-text);
  }

  /* Awards — one per line */
  .exp-ed__awards {
    display: flex;
    flex-direction: column;
    gap: 0.2em;
    margin-top: var(--exp-space-xs);
  }

  .exp-ed__award-line {
    margin: 0;
    font-family: var(--exp-font-body);
    font-size: 0.85rem;
    color: var(--exp-text-muted);
    line-height: 1.4;
  }

  .exp-ed__award-line--top {
    color: var(--exp-accent);
    font-weight: 600;
  }

  .exp-ed__award-sep {
    opacity: 0.5;
  }

  /* Notes */
  .exp-ed__notes {
    margin-top: var(--exp-space-sm);
    font-family: var(--exp-font-body);
    font-size: 0.8rem;
    color: var(--exp-text-muted);
    font-style: italic;
  }

  /* Alternating direction (even editions reversed) */
  @media (min-width: 768px) {
    .exp-ed--reversed .exp-ed__body {
      flex-direction: row-reverse;
    }
  }

  /* Mobile: stack vertically, header above poster */
  @media (max-width: 767px) {
    .exp-ed {
      margin-bottom: var(--exp-space-lg);
    }

    .exp-ed__header--mobile {
      display: block;
      margin-bottom: var(--exp-space-sm);
    }

    .exp-ed__header--desktop {
      display: none;
    }

    .exp-ed__body {
      flex-direction: column;
    }

    .exp-ed__poster {
      width: 100%;
    }

    .exp-ed__poster-img,
    .exp-ed__poster :global(img) {
      max-height: 250px;
    }
  }
</style>
