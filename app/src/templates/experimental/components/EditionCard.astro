---
/**
 * Experimental Template - EditionCard
 * Full-width band with 3 zones:
 *   Zone 1 — Stats bar (edition#, year, date, venue + award pills)
 *   Zone 2 — Poster + tunas (alternating direction per edition index)
 *   Zone 3 — Notes (optional)
 * No card borders, no card backgrounds — content lives as full-width bands.
 */

import Award from './Award.astro';
import ResponsiveImage from '@components/ResponsiveImage.astro';
import type { FrontendCitadaoEdition } from '@lib/cms/types';
import { extractPublicId } from '@lib/cms';

interface Props {
  edition: FrontendCitadaoEdition;
  labels: {
    edition: string;
    participatingTunas: string;
    guests: string;
    awards: string;
    awardLabel: (_key: string) => string;
  };
}

const { edition, labels } = Astro.props;
const posterPublicId = edition.posterUrl ? extractPublicId(edition.posterUrl) : null;
const hasPoster = !!edition.posterUrl;
const isReversed = edition.edition % 2 === 0;
const hasAwards = edition.awards && Object.keys(edition.awards).length > 0;
const awardEntries = hasAwards ? Object.entries(edition.awards!) : [];
---

<article class:list={['exp-ed', { 'exp-ed--reversed': isReversed }]} id={`citadao-${edition.year}`}>
  {/* Zone 1: Stats bar */}
  <div class="exp-ed__stats">
    <div class="exp-ed__stats-left">
      <span class="exp-ed__edition">#{edition.edition}</span>
      <span class="exp-ed__sep" aria-hidden="true">&mdash;</span>
      <span class="exp-ed__year">{edition.year}</span>
      <span class="exp-ed__sep" aria-hidden="true">&mdash;</span>
      <span class="exp-ed__date">{edition.date}</span>
      <span class="exp-ed__sep" aria-hidden="true">&mdash;</span>
      <span class="exp-ed__venue">{edition.venue}</span>
    </div>
    {hasAwards && (
      <div class="exp-ed__stats-awards">
        {awardEntries.map(([key]) => (
          <Award awardKey={key} size="sm">{labels.awardLabel(key)}</Award>
        ))}
      </div>
    )}
  </div>

  {/* Zone 2: Poster + Tunas */}
  <div class:list={['exp-ed__body', { 'exp-ed__body--no-poster': !hasPoster }]}>
    {/* Poster column */}
    {hasPoster && (
      <div class="exp-ed__poster">
        <button
          type="button"
          class="exp-ed__poster-btn"
          data-poster-url={edition.posterUrl}
          data-poster-alt={`Cartaz do ${edition.edition}. Citadao (${edition.year})`}
        >
          {posterPublicId ? (
            <ResponsiveImage
              publicId={posterPublicId}
              alt={`Cartaz do ${edition.edition}. Citadao (${edition.year})`}
              class="exp-ed__poster-img"
              sizes="(max-width: 768px) 100vw, 40vw"
              aspectRatio="2/3"
            />
          ) : (
            <img
              src={edition.posterUrl}
              alt={`Cartaz do ${edition.edition}. Citadao (${edition.year})`}
              class="exp-ed__poster-img"
              loading="lazy"
            />
          )}
        </button>
      </div>
    )}

    {/* Tunas area */}
    <div class="exp-ed__tunas-area">
      {/* Participating tunas — horizontal scroll strip */}
      {edition.tunas.length > 0 && (
        <div class="exp-ed__tuna-section">
          <span class="exp-ed__tuna-label">{labels.participatingTunas}</span>
          <div class="exp-ed__tuna-strip">
            {edition.tunas.map((tuna) => (
              <div class="exp-ed__tuna" title={tuna.fullName}>
                <div class="exp-ed__tuna-logo">
                  {tuna.logoUrl ? (
                    <img src={tuna.logoUrl} alt={tuna.shortName} loading="lazy" />
                  ) : (
                    <span class="exp-ed__tuna-initial">{tuna.shortName.charAt(0)}</span>
                  )}
                </div>
                <span class="exp-ed__tuna-name">{tuna.shortName}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Guest tunas */}
      {edition.guests && edition.guests.length > 0 && (
        <div class="exp-ed__tuna-section exp-ed__tuna-section--guests">
          <div class="exp-ed__guest-divider" aria-hidden="true"></div>
          <span class="exp-ed__tuna-label">{labels.guests}:</span>
          <span class="exp-ed__guest-list">
            {edition.guests.map((guest, i) => (
              <>{i > 0 && ', '}<span title={guest.fullName}>{guest.shortName}</span></>
            ))}
          </span>
        </div>
      )}
    </div>
  </div>

  {/* Zone 3: Notes (optional) */}
  {edition.notes && (
    <div class="exp-ed__notes">
      {edition.notes}
    </div>
  )}
</article>

<style>
  .exp-ed {
    position: relative;
    margin-bottom: 80px;
  }

  .exp-ed:last-child {
    margin-bottom: 0;
  }

  /* Zone 1: Stats bar */
  .exp-ed__stats {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--exp-space-sm);
    padding: var(--exp-space-sm) 0;
    border-bottom: 1px solid var(--exp-border);
    margin-bottom: var(--exp-space-md);
  }

  .exp-ed__stats-left {
    display: flex;
    align-items: baseline;
    flex-wrap: wrap;
    gap: 0.4em;
    font-family: var(--exp-font-display);
    font-size: 0.85rem;
    color: var(--exp-text);
  }

  .exp-ed__edition {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--exp-accent);
  }

  .exp-ed__sep {
    color: var(--exp-text-muted);
    opacity: 0.5;
  }

  .exp-ed__year {
    font-weight: 700;
  }

  .exp-ed__date,
  .exp-ed__venue {
    color: var(--exp-text-muted);
  }

  .exp-ed__stats-awards {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    justify-content: flex-end;
  }

  /* Zone 2: Poster + Tunas body */
  .exp-ed__body {
    display: flex;
    gap: var(--exp-space-md);
  }

  .exp-ed__body--no-poster {
    /* No poster: tunas take full width */
  }

  /* Poster column: 40% */
  .exp-ed__poster {
    width: 40%;
    flex-shrink: 0;
  }

  .exp-ed__poster-btn {
    display: block;
    width: 100%;
    border: none;
    padding: 0;
    background: none;
    cursor: zoom-in;
  }

  .exp-ed__poster-img,
  .exp-ed__poster :global(img) {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Tunas area: 60% (or 100% if no poster) */
  .exp-ed__tunas-area {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: var(--exp-space-sm);
  }

  .exp-ed__tuna-section {
    display: flex;
    flex-direction: column;
    gap: var(--exp-space-xs);
  }

  .exp-ed__tuna-label {
    font-family: var(--exp-font-display);
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--exp-text-muted);
  }

  /* Horizontal scrolling strip */
  .exp-ed__tuna-strip {
    display: flex;
    gap: var(--exp-space-sm);
    overflow-x: auto;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
    padding-bottom: var(--exp-space-xs);
  }

  .exp-ed__tuna-strip::-webkit-scrollbar {
    display: none;
  }

  .exp-ed__tuna {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    flex-shrink: 0;
  }

  .exp-ed__tuna-logo {
    width: 48px;
    height: 48px;
    overflow: hidden;
    border-radius: 4px;
    background: var(--exp-bg-elevated);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .exp-ed__tuna-logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 2px;
  }

  .exp-ed__tuna-initial {
    font-family: var(--exp-font-display);
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--exp-accent);
  }

  .exp-ed__tuna-name {
    font-family: var(--exp-font-display);
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--exp-text-muted);
    text-align: center;
    max-width: 48px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Guest tunas — lighter, comma-separated */
  .exp-ed__tuna-section--guests {
    flex-direction: row;
    align-items: baseline;
    flex-wrap: wrap;
    gap: 0.4em;
  }

  .exp-ed__guest-divider {
    width: 100%;
    height: 1px;
    background: var(--exp-border);
    opacity: 0.5;
    margin-bottom: 0.2em;
  }

  .exp-ed__guest-list {
    font-size: 0.75rem;
    color: var(--exp-text-muted);
  }

  /* Zone 3: Notes */
  .exp-ed__notes {
    margin-top: var(--exp-space-sm);
    font-size: 0.75rem;
    color: var(--exp-text-muted);
    font-style: italic;
  }

  /* Alternating direction (even editions reversed) */
  @media (min-width: 768px) {
    .exp-ed--reversed .exp-ed__body {
      flex-direction: row-reverse;
    }
  }

  /* Mobile: stack vertically, no alternation */
  @media (max-width: 767px) {
    .exp-ed {
      margin-bottom: var(--exp-space-lg);
    }

    .exp-ed__stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--exp-space-xs);
    }

    .exp-ed__stats-left {
      grid-column: 1 / -1;
      flex-wrap: wrap;
    }

    .exp-ed__stats-awards {
      grid-column: 1 / -1;
      justify-content: flex-start;
    }

    .exp-ed__body {
      flex-direction: column;
    }

    .exp-ed__poster {
      width: 100%;
    }

    .exp-ed__tuna-logo {
      width: 40px;
      height: 40px;
    }

    .exp-ed__tuna-name {
      max-width: 40px;
    }
  }
</style>
