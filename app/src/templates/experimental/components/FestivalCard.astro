---
/**
 * Experimental Template - FestivalCard
 * Horizontal data row — not a card. Multiple FestivalCards stack to form a scannable list.
 * Desktop: poster thumbnail + org logo + festival name + location + award pills.
 * Mobile: stacked lines; poster hidden, logo stays.
 */
import Award from './Award.astro';
import ResponsiveImage from '@components/ResponsiveImage.astro';
import type { FrontendPalmaresFestival } from '@lib/cms/types';
import { sortAwards, extractPublicId } from '@lib/cms';

interface Props {
  festival: FrontendPalmaresFestival;
  organizerLabel?: string;
  participationLabel?: string;
}

const { festival, organizerLabel = 'Organização', participationLabel = 'Participação' } = Astro.props;

const sortedAwards = sortAwards(festival.awards);
const hasNoAwards = sortedAwards.length === 0;
const posterPublicId = festival.posterUrl ? extractPublicId(festival.posterUrl) : null;
---

<article class="exp-fest-row">
  {/* Line 1: thumbnails + name + location */}
  <div class="exp-fest-row__main">
    {/* Poster thumbnail (desktop only) */}
    {festival.posterUrl && (
      <div class="exp-fest-row__poster">
        {posterPublicId ? (
          <ResponsiveImage
            publicId={posterPublicId}
            alt={`Cartaz ${festival.name}`}
            class="exp-fest-row__poster-img"
            sizes="48px"
            aspectRatio="3/4"
          />
        ) : (
          <img
            src={festival.posterUrl}
            alt={`Cartaz ${festival.name}`}
            class="exp-fest-row__poster-img"
            loading="lazy"
          />
        )}
      </div>
    )}

    {/* Organizer logo */}
    {festival.organizingTuna && (
      <div class="exp-fest-row__org-logo" title={`${organizerLabel}: ${festival.organizingTuna.fullName}`}>
        {festival.organizingTuna.logoUrl ? (
          <img
            src={festival.organizingTuna.logoUrl}
            alt={festival.organizingTuna.shortName}
            loading="lazy"
          />
        ) : (
          <span class="exp-fest-row__org-initial">
            {festival.organizingTuna.shortName.charAt(0)}
          </span>
        )}
      </div>
    )}

    {/* Festival name + location */}
    <div class="exp-fest-row__info">
      <span class="exp-fest-row__name">{festival.name}</span>
      {festival.location && (
        <>
          <span class="exp-fest-row__separator" aria-hidden="true">&mdash;</span>
          <span class="exp-fest-row__location">{festival.location}</span>
        </>
      )}
    </div>
  </div>

  {/* Line 2: Award pills */}
  <div class="exp-fest-row__awards">
    {hasNoAwards ? (
      <Award awardKey="premio-participacao" size="sm">{participationLabel}</Award>
    ) : (
      sortedAwards.map((award) => (
        <Award awardKey={award.slug} size="sm">{award.name}</Award>
      ))
    )}
  </div>
</article>

<style>
  .exp-fest-row {
    display: flex;
    flex-direction: column;
    gap: var(--exp-space-xs);
    padding: var(--exp-space-sm) var(--exp-space-md);
    border-bottom: 1px solid var(--exp-border);
    transition: background var(--exp-transition-fast);
  }

  .exp-fest-row:hover {
    background: var(--exp-bg-elevated);
  }

  .exp-fest-row:last-child {
    border-bottom: none;
  }

  /* Line 1: poster + logo + name/location */
  .exp-fest-row__main {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 0;
  }

  /* Poster thumbnail — 48px, hidden on mobile */
  .exp-fest-row__poster {
    width: 48px;
    height: 64px;
    flex-shrink: 0;
    overflow: hidden;
    border-radius: 2px;
    background: var(--exp-bg-surface);
  }

  .exp-fest-row__poster-img,
  .exp-fest-row__poster :global(img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Org logo — 32px */
  .exp-fest-row__org-logo {
    width: 32px;
    height: 32px;
    flex-shrink: 0;
    overflow: hidden;
    border-radius: 2px;
    background: var(--exp-bg-surface);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .exp-fest-row__org-logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 2px;
  }

  .exp-fest-row__org-initial {
    font-family: var(--exp-font-display);
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--exp-accent);
  }

  /* Name + location */
  .exp-fest-row__info {
    display: flex;
    align-items: baseline;
    gap: 0.5em;
    min-width: 0;
    flex-wrap: wrap;
  }

  .exp-fest-row__name {
    font-family: var(--exp-font-display);
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--exp-text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .exp-fest-row__separator {
    color: var(--exp-text-muted);
    font-size: 0.75rem;
  }

  .exp-fest-row__location {
    font-size: 0.75rem;
    color: var(--exp-text-muted);
    white-space: nowrap;
  }

  /* Awards row */
  .exp-fest-row__awards {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    padding-left: 0;
  }

  /* Desktop: indent awards under the name (past poster+logo space) */
  @media (min-width: 768px) {
    .exp-fest-row__awards {
      padding-left: calc(48px + 32px + 1.5rem);
    }

    /* If no poster, reduce indent */
    .exp-fest-row:not(:has(.exp-fest-row__poster)) .exp-fest-row__awards {
      padding-left: calc(32px + 0.75rem);
    }

    /* If neither poster nor logo */
    .exp-fest-row:not(:has(.exp-fest-row__poster)):not(:has(.exp-fest-row__org-logo)) .exp-fest-row__awards {
      padding-left: 0;
    }
  }

  /* Mobile: hide poster, stack content */
  @media (max-width: 767px) {
    .exp-fest-row__poster {
      display: none;
    }

    .exp-fest-row__info {
      flex-direction: column;
      gap: 0.15em;
    }

    .exp-fest-row__separator {
      display: none;
    }
  }
</style>
