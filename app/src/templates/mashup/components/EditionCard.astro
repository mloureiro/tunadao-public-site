---
/**
 * Mashup Template - EditionCard
 * Vinyl sleeve / album cover aesthetic for CITADAO editions.
 * Poster as a vinyl record sleeve. Credits-style typography.
 */
import Award from './Award.astro';
import ResponsiveImage from '@components/ResponsiveImage.astro';
import type { FrontendCitadaoEdition } from '@lib/cms/types';
import { groupAwardsByTuna, extractPublicId } from '@lib/cms';

interface Props {
  edition: FrontendCitadaoEdition;
  labels: {
    edition: string;
    participatingTunas: string;
    guests: string;
    awards: string;
    awardLabel: (_key: string) => string;
  };
}

const { edition, labels } = Astro.props;
const posterPublicId = edition.posterUrl ? extractPublicId(edition.posterUrl) : null;

const awardWinningTunas = groupAwardsByTuna(edition);
const awardWinnerShortNames = new Set(awardWinningTunas.map(({ tuna }) => tuna.shortName));
const tunasWithoutAwards = edition.tunas.filter((tuna) => !awardWinnerShortNames.has(tuna.shortName));
---

<article class="mash-edition" id={`citadao-${edition.year}`}>
  {/* Header - album title card */}
  <div class="mash-edition__header">
    <div class="mash-edition__title-block">
      <span class="mash-edition__number">
        {edition.edition}{labels.edition}
      </span>
      <h3 class="mash-edition__title">CITADAO {edition.year}</h3>
    </div>
    <div class="mash-edition__meta">
      <span class="mash-edition__date">{edition.date}</span>
      <span class="mash-edition__venue">{edition.venue}</span>
    </div>
    {edition.notes && <span class="mash-edition__badge">{edition.notes}</span>}
  </div>

  <div class={`mash-edition__content ${edition.posterUrl ? 'has-poster' : ''}`}>
    {/* Poster - vinyl sleeve */}
    {edition.posterUrl && (
      <div class="mash-edition__sleeve">
        <button
          type="button"
          class="mash-edition__sleeve-btn"
          data-poster-url={edition.posterUrl}
          data-poster-alt={`Cartaz do ${edition.edition}º Citadão (${edition.year})`}
        >
          <div class="mash-edition__sleeve-frame">
            {posterPublicId ? (
              <ResponsiveImage
                publicId={posterPublicId}
                alt={`Cartaz do ${edition.edition}º Citadão (${edition.year})`}
                class="mash-edition__sleeve-img"
                sizes="(max-width: 768px) 100vw, 280px"
                aspectRatio="2/3"
              />
            ) : (
              <img
                src={edition.posterUrl}
                alt={`Cartaz do ${edition.edition}º Citadão (${edition.year})`}
                class="mash-edition__sleeve-img"
                loading="lazy"
              />
            )}
          </div>
          <span class="mash-edition__sleeve-edge" aria-hidden="true"></span>
        </button>
      </div>
    )}

    {/* Info - liner notes */}
    <div class="mash-edition__info">
      {/* Participating tunas */}
      {tunasWithoutAwards.length > 0 && (
        <div class="mash-edition__section">
          <h4 class="mash-edition__section-label">{labels.participatingTunas}</h4>
          <div class="mash-edition__tunas">
            {tunasWithoutAwards.map((tuna) => (
              <div class="mash-edition__tuna" title={tuna.fullName}>
                <div class="mash-edition__tuna-avatar">
                  {tuna.logoUrl ? (
                    <img
                      src={tuna.logoUrl}
                      alt={tuna.shortName}
                      class="mash-edition__tuna-img"
                      loading="lazy"
                    />
                  ) : (
                    <span class="mash-edition__tuna-initial">
                      {tuna.shortName.charAt(0)}
                    </span>
                  )}
                </div>
                <span class="mash-edition__tuna-name">{tuna.shortName}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Guests */}
      {edition.guests && edition.guests.length > 0 && (
        <div class="mash-edition__section">
          <h4 class="mash-edition__section-label">{labels.guests}</h4>
          <div class="mash-edition__tunas">
            {edition.guests.map((guest) => (
              <div class="mash-edition__tuna mash-edition__tuna--guest" title={guest.fullName}>
                <div class="mash-edition__tuna-avatar">
                  {guest.logoUrl ? (
                    <img
                      src={guest.logoUrl}
                      alt={guest.shortName}
                      class="mash-edition__tuna-img"
                      loading="lazy"
                    />
                  ) : (
                    <span class="mash-edition__tuna-initial">
                      {guest.shortName.charAt(0)}
                    </span>
                  )}
                </div>
                <span class="mash-edition__tuna-name">{guest.shortName}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Awards grouped by tuna */}
      {edition.awards && Object.keys(edition.awards).length > 0 && (
        <div class="mash-edition__section mash-edition__section--awards">
          <h4 class="mash-edition__section-label">{labels.awards}</h4>
          <div class="mash-edition__awards-list">
            {groupAwardsByTuna(edition).map(({ tuna, awards }) => (
              <div class="mash-edition__award-row">
                <div class="mash-edition__award-tuna">
                  <div class="mash-edition__award-avatar">
                    {tuna.logoUrl ? (
                      <img
                        src={tuna.logoUrl}
                        alt={tuna.shortName}
                        class="mash-edition__award-img"
                        loading="lazy"
                      />
                    ) : (
                      <span class="mash-edition__award-initial">
                        {tuna.shortName.charAt(0)}
                      </span>
                    )}
                  </div>
                  <span class="mash-edition__award-name">{tuna.shortName}</span>
                </div>
                <div class="mash-edition__award-badges">
                  {awards.map((key) => (
                    <Award awardKey={key} size="sm">{labels.awardLabel(key)}</Award>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>
</article>

<style>
  .mash-edition {
    background-color: var(--mash-bg-surface, #1a2230);
    border: 1px solid var(--mash-border, #2a2a3a);
    border-radius: 3px;
    overflow: hidden;
  }

  /* Header - album title */
  .mash-edition__header {
    background: linear-gradient(135deg, var(--mash-navy, #1a1a2e), var(--mash-bg, #0d1117));
    padding: 1.25rem;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
    border-bottom: 1px solid var(--mash-accent-muted, #9a7b3e);
  }

  .mash-edition__title-block {
    flex: 1;
    min-width: 200px;
  }

  .mash-edition__number {
    display: block;
    font-family: var(--mash-font-mono, 'Space Mono', monospace);
    font-size: 0.6875rem;
    letter-spacing: var(--mash-letter-spacing-wide, 0.12em);
    text-transform: uppercase;
    color: var(--mash-accent, #d4a853);
    margin-bottom: 0.25rem;
  }

  .mash-edition__title {
    font-family: var(--mash-font-display, 'Playfair Display', Georgia, serif);
    font-size: 1.5rem;
    font-weight: 900;
    color: var(--mash-text, #f0ebe3);
    margin: 0;
    letter-spacing: -0.01em;
  }

  .mash-edition__meta {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    text-align: right;
    font-family: var(--mash-font-mono, 'Space Mono', monospace);
    font-size: 0.6875rem;
    color: var(--mash-text-secondary, #a8a091);
    letter-spacing: 0.04em;
  }

  .mash-edition__badge {
    font-family: var(--mash-font-mono, 'Space Mono', monospace);
    background-color: var(--mash-accent-muted, #9a7b3e);
    color: var(--mash-bg, #0d1117);
    padding: 0.125rem 0.5rem;
    border-radius: 2px;
    font-size: 0.625rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  /* Content */
  .mash-edition__content {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .mash-edition__content.has-poster {
    flex-direction: column;
  }

  @media (min-width: 768px) {
    .mash-edition__content.has-poster {
      flex-direction: row;
    }

    .mash-edition__content.has-poster .mash-edition__sleeve {
      flex-shrink: 0;
      width: 260px;
    }

    .mash-edition__content.has-poster .mash-edition__info {
      flex: 1;
      min-width: 0;
    }
  }

  /* Poster sleeve */
  .mash-edition__sleeve {
    display: flex;
    justify-content: center;
  }

  .mash-edition__sleeve-btn {
    display: block;
    max-width: 260px;
    border: none;
    padding: 0;
    background: none;
    cursor: zoom-in;
    position: relative;
  }

  .mash-edition__sleeve-frame {
    border-radius: 2px;
    overflow: hidden;
    background: var(--mash-bg, #0d1117);
    padding: 5px;
    border: 1px solid var(--mash-border, #2a2a3a);
    box-shadow:
      4px 4px 0 rgba(0, 0, 0, 0.2),
      8px 8px 0 rgba(0, 0, 0, 0.1);
    transition: box-shadow var(--mash-transition-medium, 0.3s ease);
  }

  .mash-edition__sleeve-btn:hover .mash-edition__sleeve-frame {
    box-shadow:
      2px 2px 0 rgba(0, 0, 0, 0.2),
      4px 4px 0 rgba(0, 0, 0, 0.1);
  }

  .mash-edition__sleeve-img {
    width: 100%;
    height: auto;
    display: block;
  }

  .mash-edition__sleeve-edge {
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 100%;
    height: 100%;
    border: 1px solid var(--mash-border-subtle, #1f1f2f);
    border-radius: 2px;
    pointer-events: none;
    z-index: -1;
  }

  /* Info - liner notes */
  .mash-edition__info {
    display: grid;
    gap: 1.25rem;
  }

  @media (min-width: 768px) {
    .mash-edition__info {
      grid-template-columns: 1fr 1fr;
    }

    .mash-edition__section--awards {
      grid-column: 1 / -1;
    }
  }

  .mash-edition__section-label {
    font-family: var(--mash-font-mono, 'Space Mono', monospace);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: var(--mash-letter-spacing-wide, 0.12em);
    color: var(--mash-accent, #d4a853);
    margin-bottom: 0.75rem;
    padding-bottom: 0.375rem;
    border-bottom: 1px solid var(--mash-border-subtle, #1f1f2f);
  }

  /* Tunas */
  .mash-edition__tunas {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .mash-edition__tuna {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    cursor: default;
  }

  .mash-edition__tuna-avatar {
    width: 44px;
    height: 44px;
    border-radius: 2px;
    overflow: hidden;
    border: 1px solid var(--mash-accent-muted, #9a7b3e);
    background-color: var(--mash-bg, #0d1117);
    transition: border-color 0.15s ease;
  }

  .mash-edition__tuna:hover .mash-edition__tuna-avatar {
    border-color: var(--mash-accent, #d4a853);
  }

  .mash-edition__tuna--guest .mash-edition__tuna-avatar {
    border-color: var(--mash-border, #2a2a3a);
  }

  .mash-edition__tuna-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .mash-edition__tuna-initial {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    font-family: var(--mash-font-display, 'Playfair Display', Georgia, serif);
    font-size: 1rem;
    font-weight: 700;
    color: var(--mash-accent, #d4a853);
    background: linear-gradient(135deg, var(--mash-navy, #1a1a2e), var(--mash-bg, #0d1117));
  }

  .mash-edition__tuna-name {
    font-family: var(--mash-font-mono, 'Space Mono', monospace);
    font-size: 0.5625rem;
    letter-spacing: 0.04em;
    color: var(--mash-text-muted, #6b6560);
    text-align: center;
    max-width: 64px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Awards */
  .mash-edition__awards-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .mash-edition__award-row {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 0.625rem;
    background-color: var(--mash-bg, #0d1117);
    border-radius: 2px;
    border: 1px solid var(--mash-border-subtle, #1f1f2f);
  }

  @media (min-width: 480px) {
    .mash-edition__award-row {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
  }

  .mash-edition__award-tuna {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .mash-edition__award-avatar {
    width: 28px;
    height: 28px;
    border-radius: 2px;
    overflow: hidden;
    flex-shrink: 0;
    border: 1px solid var(--mash-border, #2a2a3a);
  }

  .mash-edition__award-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .mash-edition__award-initial {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    font-family: var(--mash-font-display, 'Playfair Display', Georgia, serif);
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--mash-accent, #d4a853);
    background: linear-gradient(135deg, var(--mash-navy, #1a1a2e), var(--mash-bg, #0d1117));
  }

  .mash-edition__award-name {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--mash-text, #f0ebe3);
  }

  .mash-edition__award-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }
</style>
