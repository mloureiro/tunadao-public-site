---
/**
 * Mashup Template - FestivalCard
 * Vintage program card with Blue Note heritage aesthetic.
 * Framed poster, serif titles, heritage medal badges.
 */
import { Icon } from '@ui/icons';
import Award from './Award.astro';
import ResponsiveImage from '@components/ResponsiveImage.astro';
import type { FrontendPalmaresFestival } from '@lib/cms/types';
import { sortAwards, isTopPrize, extractPublicId } from '@lib/cms';

interface Props {
  festival: FrontendPalmaresFestival;
  organizerLabel?: string;
  participationLabel?: string;
}

const { festival, organizerLabel = 'Organização', participationLabel = 'Participação' } = Astro.props;

const sortedAwards = sortAwards(festival.awards);
const hasTopPrize = sortedAwards.length > 0 && isTopPrize(sortedAwards[0].slug);
const hasNoAwards = sortedAwards.length === 0;
const festivalInitial = festival.name.charAt(0).toUpperCase();
const posterPublicId = festival.posterUrl ? extractPublicId(festival.posterUrl) : null;
---

<article class:list={['mash-festival', { 'mash-festival--featured': hasTopPrize }]}>
  {/* Poster - framed vintage print */}
  <div class="mash-festival__poster">
    {festival.posterUrl ? (
      <button
        type="button"
        class="mash-festival__poster-btn"
        data-poster-url={festival.posterUrl}
        data-poster-alt={`Cartaz ${festival.name}`}
      >
        <div class="mash-festival__poster-frame">
          {posterPublicId ? (
            <ResponsiveImage
              publicId={posterPublicId}
              alt={`Cartaz ${festival.name}`}
              class="mash-festival__poster-img"
              sizes="(max-width: 768px) 50vw, 300px"
              aspectRatio="3/4"
            />
          ) : (
            <img
              src={festival.posterUrl}
              alt={`Cartaz ${festival.name}`}
              class="mash-festival__poster-img"
              loading="lazy"
            />
          )}
        </div>
        <span class="mash-festival__poster-zoom">
          <Icon name="zoom-in" size={18} />
        </span>
      </button>
    ) : (
      <div class="mash-festival__poster-placeholder">
        <span class="mash-festival__poster-initial">{festivalInitial}</span>
        <span class="mash-festival__poster-notes" aria-hidden="true">&flat;</span>
      </div>
    )}
  </div>

  {/* Content */}
  <div class="mash-festival__body">
    <header class="mash-festival__header">
      <h3 class="mash-festival__name">{festival.name}</h3>
      {festival.location && (
        <p class="mash-festival__location">
          <Icon name="map-pin" size={13} />
          <span>{festival.location}</span>
        </p>
      )}
    </header>

    {/* Organizer credits line */}
    {festival.organizingTuna && (
      <div class="mash-festival__organizer">
        <div class="mash-festival__org-avatar">
          {festival.organizingTuna.logoUrl ? (
            <img
              src={festival.organizingTuna.logoUrl}
              alt={festival.organizingTuna.shortName}
              loading="lazy"
            />
          ) : (
            <span class="mash-festival__org-initial">
              {festival.organizingTuna.shortName.charAt(0)}
            </span>
          )}
        </div>
        <div class="mash-festival__org-info">
          <span class="mash-festival__org-label">{organizerLabel}</span>
          {festival.organizingTuna.website ? (
            <a
              href={festival.organizingTuna.website}
              target="_blank"
              rel="noopener noreferrer"
              class="mash-festival__org-name"
              title={festival.organizingTuna.fullName}
            >
              {festival.organizingTuna.shortName}
            </a>
          ) : (
            <span class="mash-festival__org-name" title={festival.organizingTuna.fullName}>
              {festival.organizingTuna.shortName}
            </span>
          )}
        </div>
      </div>
    )}

    {/* Awards - vintage medal badges */}
    <footer class="mash-festival__awards">
      {hasNoAwards ? (
        <Award awardKey="premio-participacao" size="sm">{participationLabel}</Award>
      ) : (
        sortedAwards.map((award) => (
          <Award awardKey={award.slug} size="sm">{award.name}</Award>
        ))
      )}
    </footer>
  </div>
</article>

<style>
  .mash-festival {
    background-color: var(--mash-bg-surface, #1a2230);
    border: 1px solid var(--mash-border, #2a2a3a);
    border-radius: 3px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition:
      transform var(--mash-transition-medium, 0.3s ease),
      box-shadow var(--mash-transition-medium, 0.3s ease),
      border-color var(--mash-transition-medium, 0.3s ease);
  }

  .mash-festival:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    border-color: var(--mash-border, #2a2a3a);
  }

  .mash-festival--featured {
    border-color: var(--mash-accent-muted, #9a7b3e);
    box-shadow: 0 0 0 1px rgba(212, 168, 83, 0.1);
  }

  .mash-festival--featured:hover {
    border-color: var(--mash-accent, #d4a853);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--mash-accent-muted, #9a7b3e);
  }

  /* Poster */
  .mash-festival__poster {
    position: relative;
    aspect-ratio: 3 / 4;
    background-color: var(--mash-bg, #0d1117);
    overflow: hidden;
  }

  .mash-festival__poster-btn {
    display: block;
    width: 100%;
    height: 100%;
    border: none;
    padding: 0;
    background: none;
    cursor: zoom-in;
    position: relative;
  }

  .mash-festival__poster-frame {
    width: 100%;
    height: 100%;
    padding: 6px;
    background: linear-gradient(135deg, var(--mash-border, #2a2a3a), var(--mash-bg-surface, #1a2230));
  }

  .mash-festival__poster-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--mash-transition-slow, 0.5s ease);
  }

  .mash-festival:hover .mash-festival__poster-img {
    transform: scale(1.03);
  }

  .mash-festival__poster-zoom {
    position: absolute;
    bottom: 0.75rem;
    right: 0.75rem;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(13, 17, 23, 0.7);
    color: var(--mash-accent, #d4a853);
    border: 1px solid var(--mash-accent-muted, #9a7b3e);
    border-radius: 2px;
    opacity: 0;
    transform: scale(0.9);
    transition: opacity 0.2s ease, transform 0.2s ease;
  }

  .mash-festival__poster-btn:hover .mash-festival__poster-zoom,
  .mash-festival__poster-btn:focus .mash-festival__poster-zoom {
    opacity: 1;
    transform: scale(1);
  }

  /* Placeholder */
  .mash-festival__poster-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--mash-navy, #1a1a2e), var(--mash-bg, #0d1117));
    position: relative;
  }

  .mash-festival__poster-initial {
    font-family: var(--mash-font-display, 'Playfair Display', Georgia, serif);
    font-size: 3.5rem;
    font-weight: 900;
    color: var(--mash-accent-muted, #9a7b3e);
    opacity: 0.6;
  }

  .mash-festival__poster-notes {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    font-size: 1.5rem;
    color: var(--mash-accent-muted, #9a7b3e);
    opacity: 0.2;
  }

  /* Body */
  .mash-festival__body {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.875rem;
    flex: 1;
  }

  .mash-festival__header {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .mash-festival__name {
    font-family: var(--mash-font-display, 'Playfair Display', Georgia, serif);
    font-size: 1rem;
    font-weight: 700;
    color: var(--mash-text, #f0ebe3);
    line-height: 1.3;
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .mash-festival__location {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-family: var(--mash-font-mono, 'Space Mono', monospace);
    font-size: 0.6875rem;
    letter-spacing: 0.04em;
    color: var(--mash-text-muted, #6b6560);
    margin: 0;
  }

  .mash-festival__location svg {
    color: var(--mash-accent-muted, #9a7b3e);
    flex-shrink: 0;
  }

  /* Organizer credits */
  .mash-festival__organizer {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.625rem;
    background-color: var(--mash-bg, #0d1117);
    border-radius: 2px;
    border: 1px solid var(--mash-border-subtle, #1f1f2f);
    margin-top: auto;
  }

  .mash-festival__org-avatar {
    width: 36px;
    height: 36px;
    border-radius: 2px;
    overflow: hidden;
    flex-shrink: 0;
    background-color: var(--mash-bg-surface, #1a2230);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--mash-border, #2a2a3a);
  }

  .mash-festival__org-avatar img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 3px;
  }

  .mash-festival__org-initial {
    font-family: var(--mash-font-display, 'Playfair Display', Georgia, serif);
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--mash-accent, #d4a853);
  }

  .mash-festival__org-info {
    display: flex;
    flex-direction: column;
    gap: 1px;
    min-width: 0;
  }

  .mash-festival__org-label {
    font-family: var(--mash-font-mono, 'Space Mono', monospace);
    font-size: 0.5625rem;
    letter-spacing: var(--mash-letter-spacing-wide, 0.12em);
    text-transform: uppercase;
    color: var(--mash-text-muted, #6b6560);
  }

  .mash-festival__org-name {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--mash-text, #f0ebe3);
    text-decoration: none;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    transition: color 0.15s ease;
  }

  a.mash-festival__org-name:hover {
    color: var(--mash-accent, #d4a853);
  }

  /* Awards */
  .mash-festival__awards {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--mash-border-subtle, #1f1f2f);
  }

  .mash-festival__awards:empty {
    display: none;
  }
</style>
