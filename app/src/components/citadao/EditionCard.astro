---
/**
 * EditionCard - Displays a CITADÃO edition with poster, tunas, and awards
 * Used in the citadao index page to show each edition.
 */

import Award from '@components/Award.astro';
import type { FrontendCitadaoEdition } from '@lib/cms/types';
import { groupAwardsByTuna } from '@lib/cms';

interface Props {
  edition: FrontendCitadaoEdition;
  labels: {
    edition: string;
    participatingTunas: string;
    guests: string;
    awards: string;
    awardLabel: (_key: string) => string;
  };
}

const { edition, labels } = Astro.props;
---

<article class="edition-item" id={`citadao-${edition.year}`}>
  <div class="edition-item__header">
    <div class="edition-item__title">
      <span class="edition-item__number">
        {edition.edition}
        {labels.edition}
      </span>
      <h3>CITADÃO {edition.year}</h3>
    </div>
    <div class="edition-item__meta">
      <span class="edition-item__date">{edition.date}</span>
      <span class="edition-item__venue">{edition.venue}</span>
    </div>
    {edition.notes && <span class="edition-item__badge">{edition.notes}</span>}
  </div>

  <div class={`edition-item__content ${edition.posterUrl ? 'has-poster' : ''}`}>
    {/* Poster */}
    {edition.posterUrl && (
      <div class="edition-item__poster">
        <button
          type="button"
          class="poster-link"
          data-poster-url={edition.posterUrl}
          data-poster-alt={`Cartaz do ${edition.edition}º Citadão (${edition.year})`}
        >
          <img
            src={edition.posterUrl}
            alt={`Cartaz do ${edition.edition}º Citadão (${edition.year})`}
            class="poster-image"
            loading="lazy"
          />
        </button>
      </div>
    )}

    <div class="edition-item__info">
      {/* Tunas Participantes */}
      <div class="edition-item__section edition-item__section--full">
        <h4>{labels.participatingTunas}</h4>
        <div class="tunas-avatars">
          {edition.tunas.map((tuna) => (
            <div class="tuna-avatar" title={tuna.fullName}>
              <div class="tuna-avatar__ring">
                {tuna.logoUrl ? (
                  <img
                    src={tuna.logoUrl}
                    alt={tuna.shortName}
                    class="tuna-avatar__img"
                    loading="lazy"
                  />
                ) : (
                  <div class="tuna-avatar__placeholder">
                    <span>{tuna.shortName.charAt(0)}</span>
                  </div>
                )}
              </div>
              <span class="tuna-avatar__name">{tuna.shortName}</span>
            </div>
          ))}
        </div>
      </div>

      {/* Convidados */}
      {edition.guests && edition.guests.length > 0 && (
        <div class="edition-item__section edition-item__section--full">
          <h4>{labels.guests}</h4>
          <div class="tunas-avatars">
            {edition.guests.map((guest) => (
              <div class="tuna-avatar tuna-avatar--guest" title={guest.fullName}>
                <div class="tuna-avatar__ring">
                  {guest.logoUrl ? (
                    <img
                      src={guest.logoUrl}
                      alt={guest.shortName}
                      class="tuna-avatar__img"
                      loading="lazy"
                    />
                  ) : (
                    <div class="tuna-avatar__placeholder">
                      <span>{guest.shortName.charAt(0)}</span>
                    </div>
                  )}
                </div>
                <span class="tuna-avatar__name">{guest.shortName}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Prémios agrupados por tuna */}
      {edition.awards && Object.keys(edition.awards).length > 0 && (
        <div class="edition-item__section edition-item__awards">
          <h4>{labels.awards}</h4>
          <div class="awards-by-tuna">
            {groupAwardsByTuna(edition).map(({ tuna, awards }) => (
              <div class="award-tuna-row">
                <div class="award-tuna-row__tuna">
                  <div class="award-tuna-row__avatar">
                    {tuna.logoUrl ? (
                      <img
                        src={tuna.logoUrl}
                        alt={tuna.shortName}
                        class="award-tuna-row__img"
                        loading="lazy"
                      />
                    ) : (
                      <div class="award-tuna-row__placeholder">
                        <span>{tuna.shortName.charAt(0)}</span>
                      </div>
                    )}
                  </div>
                  <span class="award-tuna-row__name">{tuna.shortName}</span>
                </div>
                <div class="award-tuna-row__awards">
                  {awards.map((key) => (
                    <Award awardKey={key} size="sm">{labels.awardLabel(key)}</Award>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>
</article>

<style>
  .edition-item {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    overflow: hidden;
  }

  .edition-item__header {
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    color: var(--color-text-inverted);
    padding: var(--space-5);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-4);
  }

  .edition-item__title {
    flex: 1;
    min-width: 200px;
  }

  .edition-item__number {
    display: block;
    font-size: var(--text-sm);
    opacity: 0.85;
    margin-bottom: var(--space-1);
  }

  .edition-item__title h3 {
    font-size: var(--text-2xl);
    font-weight: 700;
    margin: 0;
  }

  .edition-item__meta {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    text-align: right;
    font-size: var(--text-sm);
    opacity: 0.9;
  }

  .edition-item__badge {
    background-color: var(--color-secondary);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: 600;
  }

  .edition-item__content {
    padding: var(--space-5);
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
  }

  .edition-item__content.has-poster {
    flex-direction: column;
  }

  @media (min-width: 768px) {
    .edition-item__content.has-poster {
      flex-direction: row;
    }

    .edition-item__content.has-poster .edition-item__poster {
      flex-shrink: 0;
      width: 200px;
    }

    .edition-item__content.has-poster .edition-item__info {
      flex: 1;
      min-width: 0;
    }
  }

  /* Info Section */
  .edition-item__info {
    display: grid;
    gap: var(--space-5);
  }

  @media (min-width: 768px) {
    .edition-item__info {
      grid-template-columns: 1fr 1fr;
    }

    .edition-item__awards {
      grid-column: 1 / -1;
    }
  }

  /* Poster Section */
  .edition-item__poster {
    display: flex;
    justify-content: center;
  }

  .poster-link {
    display: block;
    max-width: 200px;
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    transition:
      transform 0.2s ease,
      box-shadow 0.2s ease;
    cursor: zoom-in;
    border: none;
    padding: 0;
    background: none;
  }

  .poster-link:hover {
    transform: scale(1.02);
    box-shadow: var(--shadow-lg);
  }

  .poster-image {
    width: 100%;
    height: auto;
    display: block;
  }

  .edition-item__section h4 {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-3);
  }

  .edition-item__section--full {
    grid-column: 1 / -1;
  }

  .tunas-avatars {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .tuna-avatar {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
    cursor: default;
  }

  .tuna-avatar__ring {
    width: 52px;
    height: 52px;
    border-radius: var(--radius-full);
    padding: 2px;
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .tuna-avatar:hover .tuna-avatar__ring {
    transform: scale(1.08);
    box-shadow: 0 4px 12px rgba(var(--color-primary-rgb, 79, 70, 229), 0.3);
  }

  .tuna-avatar--guest .tuna-avatar__ring {
    background: linear-gradient(135deg, var(--color-text-muted), var(--color-border));
  }

  .tuna-avatar__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: var(--radius-full);
    background-color: var(--color-surface);
  }

  .tuna-avatar__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    color: var(--color-text-inverted);
    font-size: var(--text-lg);
    font-weight: 700;
  }

  .tuna-avatar__name {
    font-size: var(--text-xs);
    font-weight: 500;
    color: var(--color-text-muted);
    text-align: center;
    max-width: 70px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .awards-by-tuna {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .award-tuna-row {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    padding: var(--space-3);
    background-color: var(--color-background);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border-light);
  }

  @media (min-width: 480px) {
    .award-tuna-row {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
  }

  .award-tuna-row__tuna {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-shrink: 0;
  }

  .award-tuna-row__avatar {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-md);
    overflow: hidden;
    flex-shrink: 0;
  }

  .award-tuna-row__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .award-tuna-row__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    color: var(--color-text-inverted);
    font-size: var(--font-size-sm);
    font-weight: 600;
  }

  .award-tuna-row__name {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text);
  }

  .award-tuna-row__awards {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }
</style>
