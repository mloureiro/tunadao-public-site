---
import Layout from '@layouts/Layout.astro';
import Button from '@components/Button.astro';
import { useTranslations, getLocalizedPath, type Language, defaultLang } from '@i18n/index';
import { getVideos } from '@lib/cms';
import { Icon } from '@ui/icons';

export function getStaticPaths() {
  return [{ params: { lang: undefined } }, { params: { lang: 'en' } }];
}

const { lang } = Astro.params;
const currentLang: Language = (lang as Language) || defaultLang;
const t = useTranslations(currentLang);
const _l = (path: string) => getLocalizedPath(path, currentLang);

// Fetch videos from CMS (with fallback)
const videos = await getVideos();

const categories = [
  { key: 'all', label: t('videos.categories.all') },
  { key: 'atuacao', label: t('videos.categories.atuacao') },
  { key: 'festival', label: t('videos.categories.festival') },
  { key: 'serenata', label: t('videos.categories.serenata') },
  { key: 'citadao', label: t('videos.categories.citadao') },
  { key: 'outro', label: t('videos.categories.outro') },
];
---

<Layout title={`${t('videos.title')} | TunadÃ£o 1998`} description={t('videos.description')}>
  <!-- Hero Section -->
  <section class="hero">
    <div class="container">
      <h1 class="hero__title">{t('videos.title')}</h1>
      <p class="hero__subtitle">{t('videos.subtitle')}</p>
    </div>
  </section>

  <!-- Categories Filter -->
  <section class="categories">
    <div class="container">
      <div class="categories__list">
        {
          categories.map((category, index) => (
            <button
              class="category-btn"
              class:list={{ 'category-btn--active': index === 0 }}
              data-category={category.key}
            >
              {category.label}
            </button>
          ))
        }
      </div>
    </div>
  </section>

  <!-- Videos Grid -->
  <section class="videos">
    <div class="container">
      <div class="videos__grid">
        {
          videos.map((video) => (
            <div class="video-card" data-category={video.category}>
              <div class="video-card__thumbnail">
                <img
                  src={`https://img.youtube.com/vi/${video.youtubeId}/maxresdefault.jpg`}
                  alt={video.title}
                  loading="lazy"
                />
                <div class="video-card__overlay">
                  <button class="video-card__play" data-youtube-id={video.youtubeId}>
                    <Icon name="play" size={48} />
                  </button>
                </div>
                <span class="video-card__year">{video.year}</span>
              </div>
              <div class="video-card__content">
                <h3 class="video-card__title">{video.title}</h3>
                <a
                  href={`https://www.youtube.com/watch?v=${video.youtubeId}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="video-card__link"
                >
                  {t('videos.watchOn')}
                  <Icon name="external-link" size={14} />
                </a>
              </div>
            </div>
          ))
        }
      </div>

      {
        videos.length === 0 && (
          <div class="videos__empty">
            <p>{t('common.noResults')}</p>
          </div>
        )
      }
    </div>
  </section>

  <!-- YouTube CTA -->
  <section class="youtube-cta">
    <div class="container">
      <div class="youtube-cta__content">
        <Icon name="youtube" size={48} />
        <h2>{t('videos.youtubeCta.title')}</h2>
        <p>{t('videos.youtubeCta.description')}</p>
        <Button
          href="https://www.youtube.com/@TUNADAO1998"
          variant="primary"
          size="lg"
          target="_blank"
        >
          {t('videos.youtubeCta.button')}
        </Button>
      </div>
    </div>
  </section>
</Layout>

<!-- Video Modal -->
<div class="video-modal" id="videoModal">
  <div class="video-modal__overlay"></div>
  <div class="video-modal__content">
    <button class="video-modal__close" aria-label="Fechar">
      <Icon name="close" size={24} />
    </button>
    <div class="video-modal__iframe-container">
      <iframe
        id="videoIframe"
        src=""
        title="YouTube video player"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen></iframe>
    </div>
  </div>
</div>

<style>
  /* Hero Section */
  .hero {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    color: var(--color-text-inverted);
    padding: var(--space-12) 0;
    text-align: center;
  }

  .hero__title {
    font-size: var(--text-4xl);
    font-weight: 700;
    margin-bottom: var(--space-2);
  }

  .hero__subtitle {
    font-size: var(--text-xl);
    opacity: 0.9;
  }

  /* Categories */
  .categories {
    padding: var(--space-6) 0;
    background-color: var(--color-surface);
    border-bottom: 1px solid var(--color-border);
  }

  .categories__list {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
    justify-content: center;
  }

  .category-btn {
    padding: var(--space-2) var(--space-4);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    background-color: transparent;
    color: var(--color-text);
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .category-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .category-btn--active {
    background-color: var(--color-primary);
    border-color: var(--color-primary);
    color: var(--color-text-inverted);
  }

  /* Videos Grid */
  .videos {
    padding: var(--space-12) 0;
    background-color: var(--color-background);
  }

  .videos__grid {
    display: grid;
    gap: var(--space-6);
    grid-template-columns: repeat(1, 1fr);
  }

  @media (min-width: 768px) {
    .videos__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .videos__grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .videos__empty {
    text-align: center;
    padding: var(--space-12) 0;
    color: var(--color-text-muted);
  }

  /* Video Card */
  .video-card {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition:
      transform var(--transition-normal),
      box-shadow var(--transition-normal);
  }

  .video-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  .video-card__thumbnail {
    position: relative;
    aspect-ratio: 16 / 9;
    overflow: hidden;
  }

  .video-card__thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-normal);
  }

  .video-card:hover .video-card__thumbnail img {
    transform: scale(1.05);
  }

  .video-card__overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.3);
    opacity: 0;
    transition: opacity var(--transition-normal);
  }

  .video-card:hover .video-card__overlay {
    opacity: 1;
  }

  .video-card__play {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 72px;
    height: 72px;
    border: none;
    border-radius: var(--radius-full);
    background-color: var(--color-primary);
    color: var(--color-text-inverted);
    cursor: pointer;
    transition:
      transform var(--transition-fast),
      background-color var(--transition-fast);
  }

  .video-card__play:hover {
    transform: scale(1.1);
    background-color: var(--color-primary-dark);
  }

  .video-card__year {
    position: absolute;
    top: var(--space-3);
    right: var(--space-3);
    padding: var(--space-1) var(--space-2);
    background-color: rgba(0, 0, 0, 0.7);
    color: var(--color-text-inverted);
    font-size: var(--text-xs);
    font-weight: 500;
    border-radius: var(--radius-sm);
  }

  .video-card__content {
    padding: var(--space-4);
  }

  .video-card__title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .video-card__link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--text-sm);
    color: var(--color-primary);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .video-card__link:hover {
    color: var(--color-primary-dark);
  }

  /* YouTube CTA */
  .youtube-cta {
    padding: var(--space-12) 0;
    background: linear-gradient(135deg, #ff0000, #cc0000);
    color: var(--color-text-inverted);
  }

  .youtube-cta__content {
    text-align: center;
    max-width: 600px;
    margin: 0 auto;
  }

  .youtube-cta__content svg {
    margin-bottom: var(--space-4);
  }

  .youtube-cta__content h2 {
    font-size: var(--text-3xl);
    font-weight: 700;
    margin-bottom: var(--space-3);
  }

  .youtube-cta__content p {
    font-size: var(--text-lg);
    opacity: 0.9;
    margin-bottom: var(--space-6);
  }

  /* Video Modal */
  .video-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .video-modal.active {
    display: flex;
  }

  .video-modal__overlay {
    position: absolute;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.9);
  }

  .video-modal__content {
    position: relative;
    width: 90%;
    max-width: 1000px;
    z-index: 1;
  }

  .video-modal__close {
    position: absolute;
    top: -40px;
    right: 0;
    padding: var(--space-2);
    border: none;
    background: transparent;
    color: var(--color-text-inverted);
    cursor: pointer;
    transition: transform var(--transition-fast);
  }

  .video-modal__close:hover {
    transform: scale(1.1);
  }

  .video-modal__iframe-container {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    height: 0;
    overflow: hidden;
  }

  .video-modal__iframe-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: var(--radius-lg);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Category filter
    const categoryBtns = document.querySelectorAll('.category-btn');
    const videoCards = document.querySelectorAll('.video-card');

    categoryBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        categoryBtns.forEach((b) => b.classList.remove('category-btn--active'));
        btn.classList.add('category-btn--active');

        const category = btn.getAttribute('data-category');

        videoCards.forEach((card) => {
          const cardCategory = card.getAttribute('data-category');
          if (category === 'all' || cardCategory === category) {
            (card as HTMLElement).style.display = 'block';
          } else {
            (card as HTMLElement).style.display = 'none';
          }
        });
      });
    });

    // Video modal
    const modal = document.getElementById('videoModal');
    const iframe = document.getElementById('videoIframe') as HTMLIFrameElement;
    const playBtns = document.querySelectorAll('.video-card__play');
    const closeBtn = modal?.querySelector('.video-modal__close');
    const overlay = modal?.querySelector('.video-modal__overlay');

    function openModal(youtubeId: string) {
      if (modal && iframe) {
        iframe.src = `https://www.youtube.com/embed/${youtubeId}?autoplay=1`;
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeModal() {
      if (modal && iframe) {
        iframe.src = '';
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    playBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        const youtubeId = btn.getAttribute('data-youtube-id');
        if (youtubeId) openModal(youtubeId);
      });
    });

    closeBtn?.addEventListener('click', closeModal);
    overlay?.addEventListener('click', closeModal);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });
  });
</script>
