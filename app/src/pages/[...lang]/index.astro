---
import Layout from '@layouts/Layout.astro';
import { Image } from 'astro:assets';
import Button from '@components/Button.astro';
import Icon from '@ui/icons/Icon.astro';
import Section from '@components/Section.astro';
import SectionText from '@components/SectionText.astro';
import SectionImage from '@components/SectionImage.astro';
import StatsBar from '@components/StatsBar.astro';
import MainHero from '@components/home/MainHero.astro';
import { useTranslations, getLocalizedPath, type Language, defaultLang } from '@i18n/index';
import { getCitadaoEditions, getPalmaresYears, getAlbums, getSocialLinks } from '@lib/cms';

// Photos
import heroPhoto from '@assets/photos/palco-bandeira-25anos.jpg';
import groupPhoto from '@assets/photos/grupo-principal.jpg';
import placaPhoto from '@assets/photos/placa-25-anos.jpg';
import pandeiretaPhoto from '@assets/photos/pandeireta-closeup.jpg';

export function getStaticPaths() {
  return [{ params: { lang: undefined } }, { params: { lang: 'en' } }];
}

const { lang } = Astro.params;
const currentLang: Language = (lang as Language) || defaultLang;
const t = useTranslations(currentLang);
const l = (path: string) => getLocalizedPath(path, currentLang);

// CMS data
const [citadaoEditions, palmaresYears, albums, socialLinks] = await Promise.all([
  getCitadaoEditions(),
  getPalmaresYears(),
  getAlbums(),
  getSocialLinks(),
]);

// Compute stats
const currentYear = new Date().getFullYear();
const totalFestivals = palmaresYears.reduce((sum, y) => sum + y.festivals.length, 0);
const totalAwards = palmaresYears.reduce(
  (sum, y) => sum + y.festivals.reduce((fs, f) => fs + f.awards.length, 0),
  0
);
const bestTunaCount = palmaresYears.reduce(
  (sum, y) =>
    sum +
    y.festivals.reduce((fs, f) => fs + f.awards.filter((a) => a.slug === 'melhor-tuna').length, 0),
  0
);

const stats = [
  { value: '1998', label: t('home.stats.founded') },
  { value: `${currentYear - 1998}+`, label: t('home.stats.yearsHistory') },
  { value: String(citadaoEditions.length), label: t('home.stats.citadaoEditions') },
  { value: `${totalFestivals}+`, label: t('home.stats.festivals') },
  { value: `${totalAwards}+`, label: t('home.stats.awards') },
];

// Latest Citadao edition
const latestEdition = citadaoEditions[0];
const latestEditionYear = latestEdition ? latestEdition.year : null;
const latestEditionPosterUrl = latestEdition?.posterUrl || null;

// Inline stats for sections
const editionStats =
  latestEdition && latestEditionYear
    ? [
        { value: latestEdition.edition, label: t('home.sections.citadaoPreview.editionsLabel') },
        { value: latestEditionYear, label: t('home.sections.citadaoPreview.latestEditionLabel') },
      ]
    : [];

const achievementStats = [
  { value: totalAwards, label: t('home.sections.palmaresPreview.awardsLabel') },
  { value: totalFestivals, label: t('home.sections.palmaresPreview.festivalsLabel') },
  { value: bestTunaCount, label: t('home.sections.palmaresPreview.bestTunaLabel') },
];
---

<Layout title={`TunadÃ£o 1998 - ${t('home.subtitle')}`}>
  <MainHero
    title={t('home.title')}
    subtitle={t('home.subtitle')}
    text={t('home.heroText')}
    heroPhoto={heroPhoto}
    heroAlt={t('home.hero.heroAlt')}
  />

  <StatsBar stats={stats} ariaLabel={t('home.stats.ariaLabel')} />

  <!-- About Preview -->
  <Section
    id="sobre-preview"
    imagePosition="right"
    showGoldFrame
    divider={t('home.sections.aboutPreview.badge')}
    title={t('home.sections.aboutPreview.title')}
  >
    <SectionText>
      <p>{t('home.sections.aboutPreview.text1')}</p>
      <p>{t('home.sections.aboutPreview.text2')}</p>
      <Button href={l('/sobre')} variant="primary">
        {t('home.sections.aboutPreview.cta')}
        <Icon name="arrow-right" size={20} />
      </Button>
    </SectionText>
    <SectionImage>
      <Image
        src={groupPhoto}
        alt={t('home.sections.aboutPreview.imageAlt')}
        widths={[400, 600, 800]}
        sizes="(max-width: 1024px) 100vw, 50vw"
        style="aspect-ratio: 3/2; object-fit: cover;"
      />
    </SectionImage>
  </Section>

  <!-- Citadao Preview -->
  <Section
    id="citadao-preview"
    background="gradient"
    imagePosition="left"
    divider={t('home.sections.citadaoPreview.badge')}
    title={t('home.sections.citadaoPreview.title')}
  >
    <SectionText>
      <p>{t('home.sections.citadaoPreview.description')}</p>
      {latestEdition && <StatsBar variant="inline" showDividers stats={editionStats} />}
      <Button href={l('/citadao')} variant="red">
        {t('home.sections.citadaoPreview.cta')}
        <Icon name="arrow-right" size={20} />
      </Button>
    </SectionText>
    <SectionImage>
      {
        latestEditionPosterUrl ? (
          <img
            src={latestEditionPosterUrl}
            alt={`CITADAO ${latestEditionYear} - ${t('home.sections.citadaoPreview.posterAlt')}`}
            loading="lazy"
            style="aspect-ratio: 3/2; object-fit: cover; width: 100%;"
          />
        ) : (
          <div class="citadao-placeholder">
            <Icon name="music" size={96} class="citadao-placeholder__icon" />
            <p class="citadao-placeholder__title">CITADAO</p>
            <p class="citadao-placeholder__text">
              {t('home.sections.citadaoPreview.placeholderText')}
            </p>
          </div>
        )
      }
    </SectionImage>
  </Section>

  <!-- Palmares Preview -->
  <Section
    id="palmares-preview"
    imagePosition="right"
    showGoldFrame
    divider={t('home.sections.palmaresPreview.badge')}
    title={t('home.sections.palmaresPreview.title')}
  >
    <SectionText>
      <p>{t('home.sections.palmaresPreview.description')}</p>
      <StatsBar variant="inline" stats={achievementStats} />
      <Button href={l('/palmares')} variant="gold">
        {t('home.sections.palmaresPreview.cta')}
        <Icon name="arrow-right" size={20} />
      </Button>
    </SectionText>
    <SectionImage>
      <Image
        src={placaPhoto}
        alt={t('home.sections.palmaresPreview.imageAlt')}
        widths={[400, 600, 800]}
        sizes="(max-width: 1024px) 100vw, 50vw"
      />
    </SectionImage>
  </Section>

  <!-- Music CTA -->
  <Section
    id="music-cta"
    background="dark"
    imagePosition="left"
    divider={t('home.sections.musicCta.badge')}
    title={t('home.sections.musicCta.title')}
  >
    <SectionText>
      <p>{t('home.sections.musicCta.text')}</p>
      {
        albums.length > 0 && (
          <StatsBar
            variant="inline"
            stats={[{ value: albums.length, label: t('home.sections.musicCta.albumsLabel') }]}
          />
        )
      }
      {
        socialLinks.spotify && (
          <Button href={socialLinks.spotify} variant="white" target="_blank">
            <Icon name="spotify" size={20} />
            {t('home.sections.musicCta.cta')}
          </Button>
        )
      }
    </SectionText>
    <SectionImage>
      <Image
        src={pandeiretaPhoto}
        alt={t('home.sections.musicCta.imageAlt')}
        widths={[400, 600, 800]}
        sizes="(max-width: 1024px) 100vw, 50vw"
      />
    </SectionImage>
  </Section>
</Layout>

<style>
  /* Citadao Placeholder */
  .citadao-placeholder {
    aspect-ratio: 3 / 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--color-secondary), var(--color-primary));
    color: #ffffff;
    border-radius: var(--radius-2xl);
    padding: var(--space-8);
    text-align: center;
    box-shadow: var(--shadow-2xl);
  }

  .citadao-placeholder__icon {
    margin-bottom: var(--space-4);
    opacity: 0.8;
  }

  .citadao-placeholder__title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-black);
    margin-bottom: var(--space-2);
  }

  .citadao-placeholder__text {
    font-size: var(--font-size-sm);
    opacity: 0.8;
  }
</style>
