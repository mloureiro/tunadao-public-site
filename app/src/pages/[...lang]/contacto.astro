---
import Layout from '@layouts/Layout.astro';
import Button from '@components/Button.astro';
import SocialLinks from '@components/SocialLinks.astro';
import { useTranslations, type Language, defaultLang } from '@i18n/index';
import { getContactInfo } from '@lib/cms';
import { Icon } from '@ui/icons';

export function getStaticPaths() {
  return [{ params: { lang: undefined } }, { params: { lang: 'en' } }];
}

const { lang } = Astro.params;
const currentLang: Language = (lang as Language) || defaultLang;
const t = useTranslations(currentLang);

// Fetch contact info from CMS (with fallback)
const contactInfo = await getContactInfo();
---

<Layout title={`${t('contact.title')} | TunadÃ£o 1998`} description={t('contact.description')}>
  <!-- Hero Section -->
  <section class="hero">
    <div class="container">
      <h1 class="hero__title">{t('contact.title')}</h1>
      <p class="hero__subtitle">{t('contact.subtitle')}</p>
    </div>
  </section>

  <!-- Contact Section -->
  <section class="contact">
    <div class="container">
      <div class="contact__grid">
        <!-- Contact Form -->
        <div class="contact__form-container">
          <form class="contact-form" id="contactForm">
            <!-- Honeypot field for spam protection -->
            <input type="text" name="website" class="honeypot" tabindex="-1" autocomplete="off" />

            <div class="form-group">
              <label for="name">{t('contact.form.name')} *</label>
              <input
                type="text"
                id="name"
                name="name"
                required
                placeholder={t('contact.form.namePlaceholder')}
              />
            </div>

            <div class="form-group">
              <label for="email">{t('contact.form.email')} *</label>
              <input
                type="email"
                id="email"
                name="email"
                required
                placeholder={t('contact.form.emailPlaceholder')}
              />
            </div>

            <div class="form-group">
              <label for="subject">{t('contact.form.subject')} *</label>
              <select id="subject" name="subject" required>
                <option value="">{t('contact.form.subjectPlaceholder')}</option>
                <option value="atuacao">{t('contact.form.subjectOptions.atuacao')}</option>
                <option value="citadao">{t('contact.form.subjectOptions.citadao')}</option>
                <option value="informacao">{t('contact.form.subjectOptions.informacao')}</option>
                <option value="recrutamento">{t('contact.form.subjectOptions.recrutamento')}</option
                >
                <option value="outro">{t('contact.form.subjectOptions.outro')}</option>
              </select>
            </div>

            <div class="form-group">
              <label for="message">{t('contact.form.message')} *</label>
              <textarea
                id="message"
                name="message"
                rows="5"
                required
                placeholder={t('contact.form.messagePlaceholder')}></textarea>
            </div>

            <div class="form-actions">
              <Button type="submit" variant="primary" size="lg">
                {t('contact.form.submit')}
              </Button>
            </div>

            <div
              class="form-status"
              id="formStatus"
              data-sending={t('contact.form.sending')}
              data-success={t('contact.form.success')}
              data-error={t('contact.form.error')}
              data-submit={t('contact.form.submit')}
            >
            </div>
          </form>
        </div>

        <!-- Contact Info -->
        <div class="contact__info">
          <div class="info-card">
            <h2>{t('contact.info.title')}</h2>

            <div class="info-item">
              <div class="info-item__icon">
                <Icon name="mail" size={24} />
              </div>
              <div class="info-item__content">
                <span class="info-item__label">{t('contact.info.email')}</span>
                <a href={`mailto:${contactInfo.email}`} class="info-item__value">
                  {contactInfo.email}
                </a>
              </div>
            </div>

            <div class="info-item">
              <div class="info-item__icon">
                <Icon name="phone" size={24} />
              </div>
              <div class="info-item__content">
                <span class="info-item__label">{t('contact.info.phone')}</span>
                <a href={`tel:${contactInfo.phone.replace(/\s/g, '')}`} class="info-item__value">
                  {contactInfo.phone}
                </a>
              </div>
            </div>

            <div class="info-item">
              <div class="info-item__icon">
                <Icon name="map-pin" size={24} />
              </div>
              <div class="info-item__content">
                <span class="info-item__label">{t('contact.info.address')}</span>
                <span class="info-item__value">{contactInfo.address}</span>
              </div>
            </div>

            <div class="info-social">
              <h3>{t('contact.social')}</h3>
              <SocialLinks variant="light" />
            </div>
          </div>

          <!-- Map Embed -->
          <div class="map-container">
            <iframe
              src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3022.5!2d-7.9136!3d40.6614!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd2319b875f9d1e1%3A0x6b2e6c9f2a3d4e5f!2sTunad%C3%A3o%201998!5e0!3m2!1spt-PT!2spt!4v1705590000000"
              width="100%"
              height="250"
              style="border:0;"
              allowfullscreen=""
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
              title={t('contact.mapTitle')}></iframe>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  /* Hero Section */
  .hero {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    color: var(--color-text-inverted);
    padding: var(--space-12) 0;
    text-align: center;
  }

  .hero__title {
    font-size: var(--text-4xl);
    font-weight: 700;
    margin-bottom: var(--space-2);
  }

  .hero__subtitle {
    font-size: var(--text-xl);
    opacity: 0.9;
  }

  /* Contact Section */
  .contact {
    padding: var(--space-12) 0;
    background-color: var(--color-background);
  }

  .contact__grid {
    display: grid;
    gap: var(--space-8);
    grid-template-columns: 1fr;
  }

  @media (min-width: 1024px) {
    .contact__grid {
      grid-template-columns: 1fr 400px;
    }
  }

  /* Contact Form */
  .contact__form-container {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
  }

  .honeypot {
    position: absolute;
    left: -9999px;
    top: -9999px;
  }

  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-group label {
    display: block;
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: var(--space-3);
    font-size: var(--text-base);
    color: var(--color-text);
    background-color: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    transition:
      border-color var(--transition-fast),
      box-shadow var(--transition-fast);
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(41, 22, 111, 0.1);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 120px;
  }

  .form-actions {
    margin-top: var(--space-6);
  }

  .form-status {
    margin-top: var(--space-4);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    text-align: center;
    display: none;
  }

  .form-status.success {
    display: block;
    background-color: var(--color-success-light);
    color: var(--color-success-dark);
    border: 1px solid var(--color-success);
  }

  .form-status.error {
    display: block;
    background-color: var(--color-error-light);
    color: var(--color-error-dark);
    border: 1px solid var(--color-error);
  }

  /* Contact Info */
  .contact__info {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .info-card {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
  }

  .info-card h2 {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: var(--space-6);
  }

  .info-item {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
  }

  .info-item:last-of-type {
    margin-bottom: 0;
  }

  .info-item__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    border-radius: var(--radius-md);
    color: var(--color-text-inverted);
    flex-shrink: 0;
  }

  .info-item__content {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .info-item__label {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .info-item__value {
    font-size: var(--text-base);
    color: var(--color-text);
    text-decoration: none;
  }

  a.info-item__value:hover {
    color: var(--color-primary);
  }

  .info-social {
    margin-top: var(--space-6);
    padding-top: var(--space-6);
    border-top: 1px solid var(--color-border);
  }

  .info-social h3 {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-3);
  }

  /* Map */
  .map-container {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    overflow: hidden;
  }

  .map-container iframe {
    display: block;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('contactForm') as HTMLFormElement;
    const formStatus = document.getElementById('formStatus');

    if (form && formStatus) {
      const sendingText = formStatus.dataset.sending || 'Sending...';
      const successText = formStatus.dataset.success || 'Message sent successfully!';
      const errorText = formStatus.dataset.error || 'Error sending message.';
      const submitText = formStatus.dataset.submit || 'Send message';

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);

        // Check honeypot
        if (formData.get('website')) {
          return;
        }

        const submitButton = form.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.textContent = sendingText;
          (submitButton as HTMLButtonElement).disabled = true;
        }

        try {
          // In production, this would send to the CMS API
          // For now, simulate a successful submission
          await new Promise((resolve) => setTimeout(resolve, 1000));

          formStatus.textContent = successText;
          formStatus.className = 'form-status success';
          form.reset();
        } catch {
          formStatus.textContent = errorText;
          formStatus.className = 'form-status error';
        } finally {
          if (submitButton) {
            submitButton.textContent = submitText;
            (submitButton as HTMLButtonElement).disabled = false;
          }
        }
      });
    }
  });
</script>
