---
import Layout from '@layouts/Layout.astro';
import { useTranslations, type Language, defaultLang } from '@i18n/index';
import { getCitadaoEditions } from '@lib/cms';
import Award from '@components/Award.astro';
import { Icon } from '@ui/icons';
import type { FrontendTunaWithLogo, FrontendCitadaoEdition } from '@lib/cms/types';

// Award priority for sorting (lower = more important)
const AWARD_PRIORITY: Record<string, number> = {
  'melhor-tuna': 1,
  'tuna-mais-tuna': 2,
  'tuna-do-publico': 3,
  'segunda-melhor-tuna': 4,
  'terceira-melhor-tuna': 5,
};

interface TunaWithAwards {
  tuna: FrontendTunaWithLogo;
  awards: string[];
}

function groupAwardsByTuna(edition: FrontendCitadaoEdition): TunaWithAwards[] {
  if (!edition.awards) return [];

  // Group awards by tuna shortName
  const tunaAwardsMap = new Map<string, string[]>();
  for (const [awardKey, tunaShortName] of Object.entries(edition.awards)) {
    const existing = tunaAwardsMap.get(tunaShortName) || [];
    existing.push(awardKey);
    tunaAwardsMap.set(tunaShortName, existing);
  }

  // Build list with tuna info
  const result: TunaWithAwards[] = [];
  for (const [shortName, awards] of tunaAwardsMap) {
    const tuna = edition.tunas.find(t => t.shortName === shortName);
    if (tuna) {
      result.push({ tuna, awards });
    } else {
      // Tuna not in participants (might be guest or external)
      result.push({
        tuna: { shortName, fullName: shortName },
        awards,
      });
    }
  }

  // Sort by best award priority, then alphabetically for same priority
  result.sort((a, b) => {
    const aPriority = Math.min(...a.awards.map(k => AWARD_PRIORITY[k] ?? 100));
    const bPriority = Math.min(...b.awards.map(k => AWARD_PRIORITY[k] ?? 100));
    if (aPriority !== bPriority) {
      return aPriority - bPriority;
    }
    // Same priority: sort alphabetically by tuna shortName
    return a.tuna.shortName.localeCompare(b.tuna.shortName, 'pt');
  });

  return result;
}

export function getStaticPaths() {
  return [{ params: { lang: undefined } }, { params: { lang: 'en' } }];
}

const { lang } = Astro.params;
const currentLang: Language = (lang as Language) || defaultLang;
const t = useTranslations(currentLang);

// Fetch editions from CMS (with fallback)
const editions = await getCitadaoEditions();

// Group editions into decades for collapsible sections
interface Decade {
  label: string;
  id: string;
  editions: typeof editions;
  totalEditions: number;
}

function groupByDecade(editionsList: typeof editions): Decade[] {
  const decadeMap = new Map<number, typeof editions>();

  for (const edition of editionsList) {
    const decadeStart = Math.floor(edition.year / 10) * 10;
    const existing = decadeMap.get(decadeStart) || [];
    existing.push(edition);
    decadeMap.set(decadeStart, existing);
  }

  // Sort decades descending (most recent first)
  const sortedDecades = Array.from(decadeMap.entries())
    .sort((a, b) => b[0] - a[0]);

  return sortedDecades.map(([decadeStart, decadeEditions]) => {
    const decadeEnd = decadeStart + 9;
    return {
      label: `${decadeStart}-${decadeEnd}`,
      id: `decade-${decadeStart}`,
      editions: decadeEditions,
      totalEditions: decadeEditions.length,
    };
  });
}

const decades = groupByDecade(editions);
---

<Layout title={`${t('citadao.title')} | Tunad√£o 1998`} description={t('citadao.description')}>
  <!-- Hero Section -->
  <section class="hero">
    <div class="container">
      <h1 class="hero__title">{t('citadao.title')}</h1>
      <p class="hero__subtitle">{t('citadao.subtitle')}</p>
    </div>
  </section>


  <!-- About CITAD√ÉO Section -->
  <section class="about-citadao">
    <div class="container">
      <div class="about-citadao__content">
        <h2>{t('citadao.about.title')}</h2>
        <p set:html={t('citadao.about.p1')} />
        <p set:html={t('citadao.about.p2').replace('{count}', String(editions.length))} />
      </div>
    </div>
  </section>

  <!-- All Editions -->
  <section class="editions">
    <div class="container">
      <h2 class="section-title">{t('citadao.allEditions')}</h2>
      <div class="editions__list">
        {
          decades.map((decade, decadeIndex) => (
            <div class="decade-section" id={decade.id}>
              <button
                type="button"
                class="decade-header"
                aria-expanded={decadeIndex === 0 ? 'true' : 'false'}
                aria-controls={`${decade.id}-content`}
              >
                <div class="decade-header__left">
                  <h3 class="decade-title">{decade.label}</h3>
                  <span class="decade-count">
                    {decade.totalEditions} {decade.totalEditions === 1 ? 'edi√ß√£o' : 'edi√ß√µes'}
                  </span>
                </div>
                <span class="decade-header__icon" aria-hidden="true">
                  <Icon name="chevron-down" size={24} />
                </span>
              </button>
              <div
                class="decade-content"
                id={`${decade.id}-content`}
                data-expanded={decadeIndex === 0 ? 'true' : 'false'}
              >
                <div class="decade-content__inner">
                {decade.editions.map((edition) => (
            <article class="edition-item" id={`citadao-${edition.year}`}>
              <div class="edition-item__header">
                <div class="edition-item__title">
                  <span class="edition-item__number">
                    {edition.edition}
                    {t('citadao.edition')}
                  </span>
                  <h3>CITAD√ÉO {edition.year}</h3>
                </div>
                <div class="edition-item__meta">
                  <span class="edition-item__date">{edition.date}</span>
                  <span class="edition-item__venue">{edition.venue}</span>
                </div>
                {edition.notes && <span class="edition-item__badge">{edition.notes}</span>}
              </div>

              <div class={`edition-item__content ${edition.posterUrl ? 'has-poster' : ''}`}>
                {/* Poster */}
                {edition.posterUrl && (
                  <div class="edition-item__poster">
                    <button
                      type="button"
                      class="poster-link"
                      data-poster-url={edition.posterUrl}
                      data-poster-alt={`Cartaz do ${edition.edition}¬∫ Citad√£o (${edition.year})`}
                    >
                      <img
                        src={edition.posterUrl}
                        alt={`Cartaz do ${edition.edition}¬∫ Citad√£o (${edition.year})`}
                        class="poster-image"
                        loading="lazy"
                      />
                    </button>
                  </div>
                )}

                <div class="edition-item__info">
                  {/* Tunas Participantes */}
                  <div class="edition-item__section edition-item__section--full">
                    <h4>{t('citadao.participatingTunas')}</h4>
                    <div class="tunas-avatars">
                      {edition.tunas.map((tuna) => (
                        <div class="tuna-avatar" title={tuna.fullName}>
                          <div class="tuna-avatar__ring">
                            {tuna.logoUrl ? (
                              <img
                                src={tuna.logoUrl}
                                alt={tuna.shortName}
                                class="tuna-avatar__img"
                                loading="lazy"
                              />
                            ) : (
                              <div class="tuna-avatar__placeholder">
                                <span>{tuna.shortName.charAt(0)}</span>
                              </div>
                            )}
                          </div>
                          <span class="tuna-avatar__name">{tuna.shortName}</span>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Convidados */}
                  {edition.guests && edition.guests.length > 0 && (
                    <div class="edition-item__section edition-item__section--full">
                      <h4>{t('citadao.guests')}</h4>
                      <div class="tunas-avatars">
                        {edition.guests.map((guest) => (
                          <div class="tuna-avatar tuna-avatar--guest" title={guest.fullName}>
                            <div class="tuna-avatar__ring">
                              {guest.logoUrl ? (
                                <img
                                  src={guest.logoUrl}
                                  alt={guest.shortName}
                                  class="tuna-avatar__img"
                                  loading="lazy"
                                />
                              ) : (
                                <div class="tuna-avatar__placeholder">
                                  <span>{guest.shortName.charAt(0)}</span>
                                </div>
                              )}
                            </div>
                            <span class="tuna-avatar__name">{guest.shortName}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Pr√©mios agrupados por tuna */}
                  {edition.awards && Object.keys(edition.awards).length > 0 && (
                    <div class="edition-item__section edition-item__awards">
                      <h4>{t('citadao.awards')}</h4>
                      <div class="awards-by-tuna">
                        {groupAwardsByTuna(edition).map(({ tuna, awards }) => (
                          <div class="award-tuna-row">
                            <div class="award-tuna-row__tuna">
                              <div class="award-tuna-row__avatar">
                                {tuna.logoUrl ? (
                                  <img
                                    src={tuna.logoUrl}
                                    alt={tuna.shortName}
                                    class="award-tuna-row__img"
                                    loading="lazy"
                                  />
                                ) : (
                                  <div class="award-tuna-row__placeholder">
                                    <span>{tuna.shortName.charAt(0)}</span>
                                  </div>
                                )}
                              </div>
                              <span class="award-tuna-row__name">{tuna.shortName}</span>
                            </div>
                            <div class="award-tuna-row__awards">
                              {awards.map((key) => (
                                <Award awardKey={key} size="sm">{t(`awards.${key}`)}</Award>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </article>
                ))}
                </div>
              </div>
            </div>
          ))
        }
      </div>
    </div>
  </section>

  <!-- Lightbox Overlay -->
  <div id="poster-lightbox" class="lightbox" aria-hidden="true">
    <button type="button" class="lightbox__close" aria-label={t('common.close')}>&times;</button>
    <div class="lightbox__content">
      <img src="" alt="" class="lightbox__image" />
    </div>
  </div>
</Layout>

<script is:inline>
  (function() {
    // Decade collapsible toggle
    function initDecadeToggles() {
      document.querySelectorAll('.decade-header').forEach(function(header) {
        header.addEventListener('click', function() {
          const isExpanded = header.getAttribute('aria-expanded') === 'true';
          const contentId = header.getAttribute('aria-controls');
          const content = document.getElementById(contentId);

          header.setAttribute('aria-expanded', String(!isExpanded));
          if (content) {
            content.setAttribute('data-expanded', String(!isExpanded));
          }
        });
      });
    }

    function initLightbox() {
      const lightbox = document.getElementById('poster-lightbox');
      const lightboxImage = lightbox?.querySelector('.lightbox__image');
      const closeButton = lightbox?.querySelector('.lightbox__close');

      if (!lightbox || !lightboxImage) return;

      // Open lightbox when clicking on poster
      document.querySelectorAll('.poster-link[data-poster-url]').forEach(function(button) {
        button.addEventListener('click', function() {
          const url = button.getAttribute('data-poster-url');
          const alt = button.getAttribute('data-poster-alt') || '';
          if (url) {
            lightboxImage.src = url;
            lightboxImage.alt = alt;
            lightbox.classList.add('is-open');
            lightbox.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
          }
        });
      });

      // Close lightbox
      function closeLightbox() {
        lightbox.classList.remove('is-open');
        lightbox.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }

      closeButton?.addEventListener('click', closeLightbox);
      lightbox.addEventListener('click', function(e) {
        if (e.target === lightbox) closeLightbox();
      });
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && lightbox.classList.contains('is-open')) {
          closeLightbox();
        }
      });
    }

    function init() {
      initDecadeToggles();
      initLightbox();
    }

    // Run when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

<style>
  /* Hero Section */
  .hero {
    position: relative;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    color: var(--color-text-inverted);
    padding: var(--space-12) 0;
    text-align: center;
    overflow: hidden;
  }

  .hero::before {
    content: '';
    position: absolute;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    pointer-events: none;
  }

  .hero::after {
    content: 'üé≠';
    position: absolute;
    bottom: var(--space-4);
    right: var(--space-6);
    font-size: 2rem;
    opacity: 0.2;
    pointer-events: none;
  }

  .hero__title {
    position: relative;
    font-size: var(--text-4xl);
    font-weight: 700;
    margin-bottom: var(--space-2);
  }

  .hero__subtitle {
    position: relative;
    font-size: var(--text-xl);
    opacity: 0.9;
  }

  /* About CITAD√ÉO */
  .about-citadao {
    padding: var(--space-12) 0;
    background-color: var(--color-surface);
  }

  .about-citadao__content {
    max-width: 800px;
    margin: 0 auto;
    text-align: center;
  }

  .about-citadao__content h2 {
    font-size: var(--text-3xl);
    font-weight: 700;
    margin-bottom: var(--space-6);
    color: var(--color-text);
  }

  .about-citadao__content p {
    font-size: var(--text-lg);
    line-height: 1.8;
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .about-citadao__content p:last-child {
    margin-bottom: 0;
  }

  /* Section Title */
  .section-title {
    font-size: var(--text-3xl);
    font-weight: 700;
    margin-bottom: var(--space-8);
    color: var(--color-text);
    text-align: center;
  }

  /* Editions List */
  .editions {
    padding: var(--space-12) 0;
    background-color: var(--color-background);
  }

  .editions__list {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
    max-width: 1000px;
    margin: 0 auto;
  }

  /* Decade Sections (Collapsible) */
  .decade-section {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    overflow: hidden;
    background-color: var(--color-surface);
  }

  .decade-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: var(--space-4) var(--space-5);
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    color: var(--color-text-inverted);
    border: none;
    cursor: pointer;
    text-align: left;
    transition: opacity var(--transition-fast);
  }

  .decade-header:hover {
    opacity: 0.95;
  }

  .decade-header:focus-visible {
    outline: 2px solid var(--color-secondary);
    outline-offset: 2px;
  }

  .decade-header__left {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  @media (min-width: 640px) {
    .decade-header__left {
      flex-direction: row;
      align-items: center;
      gap: var(--space-4);
    }
  }

  .decade-title {
    font-size: var(--text-2xl);
    font-weight: 700;
    margin: 0;
  }

  .decade-count {
    font-size: var(--text-sm);
    opacity: 0.85;
  }

  .decade-header__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform var(--transition-base);
  }

  .decade-header[aria-expanded="true"] .decade-header__icon {
    transform: rotate(180deg);
  }

  .decade-content {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows var(--transition-base);
  }

  .decade-content[data-expanded="true"] {
    grid-template-rows: 1fr;
  }

  .decade-content__inner {
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding: 0;
  }

  .decade-content[data-expanded="true"] .decade-content__inner {
    padding: var(--space-5);
  }

  .edition-item {
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    overflow: hidden;
  }

  .edition-item__header {
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    color: var(--color-text-inverted);
    padding: var(--space-5);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-4);
  }

  .edition-item__title {
    flex: 1;
    min-width: 200px;
  }

  .edition-item__number {
    display: block;
    font-size: var(--text-sm);
    opacity: 0.85;
    margin-bottom: var(--space-1);
  }

  .edition-item__title h3 {
    font-size: var(--text-2xl);
    font-weight: 700;
    margin: 0;
  }

  .edition-item__meta {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    text-align: right;
    font-size: var(--text-sm);
    opacity: 0.9;
  }

  .edition-item__badge {
    background-color: var(--color-secondary);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: 600;
  }

  .edition-item__content {
    padding: var(--space-5);
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
  }

  .edition-item__content.has-poster {
    flex-direction: column;
  }

  @media (min-width: 768px) {
    .edition-item__content.has-poster {
      flex-direction: row;
    }

    .edition-item__content.has-poster .edition-item__poster {
      flex-shrink: 0;
      width: 200px;
    }

    .edition-item__content.has-poster .edition-item__info {
      flex: 1;
      min-width: 0;
    }
  }

  /* Info Section */
  .edition-item__info {
    display: grid;
    gap: var(--space-5);
  }

  @media (min-width: 768px) {
    .edition-item__info {
      grid-template-columns: 1fr 1fr;
    }

    .edition-item__awards {
      grid-column: 1 / -1;
    }
  }

  /* Poster Section */
  .edition-item__poster {
    display: flex;
    justify-content: center;
  }

  .poster-link {
    display: block;
    max-width: 200px;
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    transition:
      transform 0.2s ease,
      box-shadow 0.2s ease;
    cursor: zoom-in;
    border: none;
    padding: 0;
    background: none;
  }

  .poster-link:hover {
    transform: scale(1.02);
    box-shadow: var(--shadow-lg);
  }

  .poster-image {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Lightbox */
  .lightbox {
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.3s ease,
      visibility 0.3s ease;
  }

  .lightbox.is-open {
    opacity: 1;
    visibility: visible;
  }

  .lightbox__close {
    position: absolute;
    top: var(--space-4);
    right: var(--space-4);
    width: 44px;
    height: 44px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 2rem;
    line-height: 1;
    border-radius: var(--radius-full);
    cursor: pointer;
    transition: background 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox__close:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .lightbox__content {
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox__image {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: var(--radius-lg);
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
  }

  .edition-item__section h4 {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-3);
  }

  .edition-item__section--full {
    grid-column: 1 / -1;
  }

  .tunas-avatars {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .tuna-avatar {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
    cursor: default;
  }

  .tuna-avatar__ring {
    width: 52px;
    height: 52px;
    border-radius: var(--radius-full);
    padding: 2px;
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .tuna-avatar:hover .tuna-avatar__ring {
    transform: scale(1.08);
    box-shadow: 0 4px 12px rgba(var(--color-primary-rgb, 79, 70, 229), 0.3);
  }

  .tuna-avatar--guest .tuna-avatar__ring {
    background: linear-gradient(135deg, var(--color-text-muted), var(--color-border));
  }

  .tuna-avatar__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: var(--radius-full);
    background-color: var(--color-surface);
  }

  .tuna-avatar__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    color: var(--color-text-inverted);
    font-size: var(--text-lg);
    font-weight: 700;
  }

  .tuna-avatar__name {
    font-size: var(--text-xs);
    font-weight: 500;
    color: var(--color-text-muted);
    text-align: center;
    max-width: 70px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .awards-by-tuna {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .award-tuna-row {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    padding: var(--space-3);
    background-color: var(--color-background);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border-light);
  }

  @media (min-width: 480px) {
    .award-tuna-row {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
  }

  .award-tuna-row__tuna {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-shrink: 0;
  }

  .award-tuna-row__avatar {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-md);
    overflow: hidden;
    flex-shrink: 0;
  }

  .award-tuna-row__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .award-tuna-row__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    color: var(--color-text-inverted);
    font-size: var(--font-size-sm);
    font-weight: 600;
  }

  .award-tuna-row__name {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text);
  }

  .award-tuna-row__awards {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }
</style>
