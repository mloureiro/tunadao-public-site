---
import Layout from '@layouts/Layout.astro';
import HeroSection from '@components/HeroSection.astro';
import Section from '@components/Section.astro';
import SectionText from '@components/SectionText.astro';
import { useTranslations, type Language, defaultLang } from '@i18n/index';
import { getCitadaoEditions } from '@lib/cms';
import Lightbox from '@components/Lightbox.astro';
import EditionCard from '@components/citadao/EditionCard.astro';
import VerticalTimeline from '@components/VerticalTimeline.astro';

export function getStaticPaths() {
  return [{ params: { lang: undefined } }, { params: { lang: 'en' } }];
}

const { lang } = Astro.params;
const currentLang: Language = (lang as Language) || defaultLang;
const t = useTranslations(currentLang);

// Fetch editions from CMS (with fallback)
const editions = await getCitadaoEditions();

// Get list of all years for navigation
const allYears = editions.map((edition) => edition.year);
---

<Layout title={`${t('citadao.title')} | TunadÃ£o 1998`} description={t('citadao.description')}>
  <HeroSection title={t('citadao.title')} subtitle={t('citadao.subtitle')} />

  <Section layout="single-column" title={t('citadao.about.title')}>
    <SectionText>
      <p set:html={t('citadao.about.p1')} />
      <p set:html={t('citadao.about.p2').replace('{count}', String(editions.length))} />
    </SectionText>
  </Section>

  <!-- Year Navigation -->
  <VerticalTimeline years={allYears} ariaLabel={t('citadao.jumpToYear') || 'Jump to edition'} sectionSelector="#editions-section" />

  <Section layout="single-column" background="alt" title={t('citadao.editionsTitle')} id="editions-section">
    <div class="editions__list">
      {
        editions.map((edition) => (
          <div class="edition-wrapper" id={`year-${edition.year}`}>
            <EditionCard
              edition={edition}
              lang={currentLang}
              labels={{
                edition: t('citadao.edition'),
                viewDetails: t('citadao.viewDetails'),
                venue: t('citadao.venue'),
              }}
            />
          </div>
        ))
      }
    </div>
  </Section>

  <Lightbox closeLabel={t('common.close')} />
</Layout>


<style>
  /* Editions List Grid */
  .editions__list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-6);
    width: 100%;
  }

  /* Edition Wrapper (for year anchors) */
  .edition-wrapper {
    scroll-margin-top: 80px; /* Offset for sticky nav */
  }
</style>
