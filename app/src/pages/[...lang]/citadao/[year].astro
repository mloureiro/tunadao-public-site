---
import Layout from '@layouts/Layout.astro';
import Lightbox from '@components/Lightbox.astro';
import ParticipantList from '@components/citadao/ParticipantList.astro';
import AwardsList from '@components/citadao/AwardsList.astro';
import EditionHero from '@components/citadao/EditionHero.astro';
import EditionNavigation from '@components/citadao/EditionNavigation.astro';
import { useTranslations, getLocalizedPath, type Language, defaultLang } from '@i18n/index';
import { getCitadaoEditions, getCitadaoEditionByYear, splitTunasByAwards, extractPublicId } from '@lib/cms';

export async function getStaticPaths() {
  const languages: (string | undefined)[] = [undefined, 'en'];
  const paths: { params: { lang: string | undefined; year: string } }[] = [];
  const editions = await getCitadaoEditions();

  for (const lang of languages) {
    for (const edition of editions) {
      paths.push({ params: { lang, year: String(edition.year) } });
    }
  }
  return paths;
}

const { lang, year } = Astro.params;
const currentLang: Language = (lang as Language) || defaultLang;
const t = useTranslations(currentLang);
const l = (path: string) => getLocalizedPath(path, currentLang);

const edition = await getCitadaoEditionByYear(parseInt(year as string));
if (!edition) {
  return Astro.redirect(l('/citadao'));
}

// Navigation between editions
const allEditions = await getCitadaoEditions();
const allYears = allEditions.map((e) => e.year).sort((a, b) => b - a);
const currentIndex = allYears.indexOf(edition.year);
const prevYear = currentIndex < allYears.length - 1 ? allYears[currentIndex + 1] : null;
const nextYear = currentIndex > 0 ? allYears[currentIndex - 1] : null;

// Split tunas into those with and without prizes
const { withPrizes: tunasWithPrizes, withoutPrizes: tunasWithoutPrizes } = splitTunasByAwards(edition);

// All contestants without awards
const contestants = tunasWithoutPrizes.map(({ tuna }) => tuna);

// Poster
const posterPublicId = edition.posterUrl ? extractPublicId(edition.posterUrl) : null;
---

<Layout
  title={`${edition.edition}${t('citadao.edition')} CITADÃO ${edition.year} | Tunadão 1998`}
  description={`CITADÃO ${edition.year} - ${edition.edition}${t('citadao.edition')} ${t('citadao.editionDescription')}`}
>
  <EditionHero
    edition={edition}
    editionLabel={t('citadao.edition')}
    posterPublicId={posterPublicId}
  />

  <!-- Participants Section -->
  {(contestants.length > 0 || edition.guests.length > 0) && (
    <section class="content-section" aria-labelledby="participants-title">
      <div class="content-container">
        <h2 id="participants-title" class="section-title">
          {t('citadao.participatingTunas')}
        </h2>
        <ParticipantList
          contestants={contestants}
          guests={edition.guests}
          labels={{
            contestants: t('citadao.tunas'),
            guests: t('citadao.guests'),
            count: t('citadao.tunasCount'),
          }}
        />
      </div>
    </section>
  )}

  <!-- Awards Section -->
  {tunasWithPrizes.length > 0 && (
    <section class="content-section awards-bg" aria-label={t('citadao.awards')}>
      <div class="content-container">
        <AwardsList
          tunasWithPrizes={tunasWithPrizes}
          awardLabel={(key) => t(`awards.${key}`)}
          sectionTitle={t('citadao.awards')}
        />
      </div>
    </section>
  )}

  <!-- No data fallback -->
  {contestants.length === 0 && edition.guests.length === 0 && tunasWithPrizes.length === 0 && (
    <section class="content-section" aria-label={t('common.noResults')}>
      <div class="content-container">
        <p class="no-data-text">{t('common.noResults')}</p>
      </div>
    </section>
  )}

  <EditionNavigation
    prevYear={prevYear}
    nextYear={nextYear}
    allEditionsLabel={t('citadao.allEditions')}
    allEditionsHref={l('/citadao')}
  />

  <Lightbox closeLabel={t('common.close')} />
</Layout>

<style>
  /* Content Sections */
  .content-section {
    padding: var(--space-16) var(--space-6);
    background-color: var(--color-surface);
  }

  .awards-bg {
    background-color: var(--color-background);
  }

  .content-container {
    max-width: 1280px;
    margin: 0 auto;
  }

  .section-title {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--color-primary);
    margin: 0 0 var(--space-8) 0;
  }

  [data-theme='dark'] .section-title {
    color: var(--color-accent-gold);
  }

  .no-data-text {
    text-align: center;
    font-size: var(--font-size-lg);
    color: var(--color-text-muted);
    padding: var(--space-12) 0;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .content-section {
      padding: var(--space-10) var(--space-4);
    }

    .section-title {
      font-size: var(--font-size-xl);
    }
  }
</style>
