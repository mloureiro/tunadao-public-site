---
import { getTemplate, TEMPLATES } from '@templates/core';
import type { TemplateId } from '@templates/core';
import { useTranslations, defaultLang } from '@i18n/index';
import { getCitadaoEditions } from '@lib/cms';
import EditionCard from '@components/citadao/EditionCard.astro';
import VerticalTimeline from '@components/VerticalTimeline.astro';
import Lightbox from '@components/Lightbox.astro';

export function getStaticPaths() {
  // Only generate paths for enabled templates
  return TEMPLATES.filter((t) => t.enabled).map((t) => ({
    params: { template: t.id },
  }));
}

const { template } = Astro.params as { template: TemplateId };
const { Layout, Hero } = await getTemplate(template);

const base = import.meta.env.BASE_URL;
const templateInfo = TEMPLATES.find((t) => t.id === template);
const t = useTranslations(defaultLang);

// Fetch editions from CMS (with fallback)
const editions = await getCitadaoEditions();
const allYears = editions.map((edition) => edition.year);
---

<Layout title={`Citadao (${templateInfo?.name || template}) | Tunadao Dev`}>
  <div class="dev-banner">
    <span class="dev-banner__label">Template Preview:</span>
    <strong>{templateInfo?.name || template}</strong>
    <nav class="dev-banner__nav">
      <a href={`${base}dev/templates/${template}/`}>Home</a>
      <a href={`${base}dev/templates/${template}/citadao`} class="active">Citadao</a>
      <a href={`${base}dev/templates/${template}/palmares`}>Palmares</a>
    </nav>
    <a href={`${base}dev/templates`} class="dev-banner__back">All Templates</a>
  </div>

  <div class="page-content">
    <Hero title={t('citadao.title')} subtitle={t('citadao.subtitle')} />

    <section class="about-citadao">
      <div class="container">
        <div class="about-citadao__content">
          <h2>{t('citadao.about.title')}</h2>
          <p set:html={t('citadao.about.p1')} />
          <p set:html={t('citadao.about.p2').replace('{count}', String(editions.length))} />
        </div>
      </div>
    </section>

    <VerticalTimeline years={allYears} ariaLabel={t('citadao.jumpToYear') || 'Jump to edition'} />

    <section class="editions">
      <div class="container">
        <h2 class="section-title">{t('citadao.allEditions')}</h2>
        <div class="editions__list">
          {
            editions.map((edition) => (
              <div class="edition-wrapper" id={`year-${edition.year}`}>
                <EditionCard
                  edition={edition}
                  labels={{
                    edition: t('citadao.edition'),
                    participatingTunas: t('citadao.participatingTunas'),
                    guests: t('citadao.guests'),
                    awards: t('citadao.awards'),
                    awardLabel: (key: string) => t(`awards.${key}`),
                  }}
                />
              </div>
            ))
          }
        </div>
      </div>
    </section>

    <Lightbox closeLabel={t('common.close')} />
  </div>
</Layout>

<style>
  .dev-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #1a1a2e;
    color: white;
    padding: var(--space-2) var(--space-4);
    display: flex;
    align-items: center;
    gap: var(--space-4);
    z-index: 1000;
    font-size: var(--font-size-sm);
  }

  .dev-banner__label {
    color: #888;
  }

  .dev-banner__nav {
    display: flex;
    gap: var(--space-2);
    margin-left: auto;
  }

  .dev-banner__nav a {
    color: #aaa;
    text-decoration: none;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
  }

  .dev-banner__nav a:hover,
  .dev-banner__nav a.active {
    color: white;
    background: rgba(255, 255, 255, 0.1);
  }

  .dev-banner__back {
    color: #888;
    text-decoration: none;
  }

  .dev-banner__back:hover {
    color: white;
  }

  .page-content {
    margin-top: 48px; /* Account for fixed banner */
  }

  /* About CITADAO */
  .about-citadao {
    padding: var(--space-12) 0;
    background-color: var(--color-surface);
  }

  .about-citadao__content {
    max-width: 800px;
    margin: 0 auto;
    text-align: center;
  }

  .about-citadao__content h2 {
    font-size: var(--text-3xl);
    font-weight: 700;
    margin-bottom: var(--space-6);
    color: var(--color-text);
  }

  .about-citadao__content p {
    font-size: var(--text-lg);
    line-height: 1.8;
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .about-citadao__content p:last-child {
    margin-bottom: 0;
  }

  /* Section Title */
  .section-title {
    font-size: var(--text-3xl);
    font-weight: 700;
    margin-bottom: var(--space-8);
    color: var(--color-text);
    text-align: center;
  }

  /* Editions List */
  .editions {
    padding: var(--space-12) 0;
    background-color: var(--color-background);
  }

  .editions__list {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
    max-width: 1000px;
    margin: 0 auto;
  }

  .edition-wrapper {
    scroll-margin-top: 128px; /* Extra offset for dev banner + sticky nav */
  }
</style>
